# Fix Keyboard Input Mapping for Special Characters

## Problem

В `KeyboardInputMapper` несколько багов с маппингом специальных символов:

### 1. Архитектурный дефект

Метод `MapSpecialKey()` — **static**, не имеет доступа к `_shiftPressed`. Состояние Shift отслеживается, но не используется для спецсимволов.

### 2. Критические баги маппинга

| VKey | Текущее | Без Shift | С Shift | Проблема |
|------|---------|-----------|---------|----------|
| 0xBD | `-` всегда | `-` | `_` | **Underscore потерян** |
| 0xBB | `+` всегда | `=` | `+` | **Equals потерян** |

### 3. Неполная поддержка Shift-вариантов

| VKey | Текущее | Без Shift | С Shift | Статус |
|------|---------|-----------|---------|--------|
| 0xBC | `,` | `,` | `<` | Shift-вариант потерян |
| 0xBE | `.` | `.` | `>` | Shift-вариант потерян |
| 0xBF | `/` | `/` | `?` | Shift-вариант потерян |

### Воздействие

Штрихкоды с `_`, `=`, `<`, `>`, `?` читаются некорректно. Система не находит котёл в БД.

## Solution

### Изменить `MapSpecialKey` на instance метод

```csharp
// Было (static, без Shift)
private static char? MapSpecialKey(ushort vKey)
{
    return vKey switch
    {
        0xBD => '-',
        0xBB => '+',
        ...
    };
}

// Стало (instance, с Shift)
private char? MapSpecialKey(ushort vKey)
{
    return vKey switch
    {
        0xBD => _shiftPressed ? '_' : '-',
        0xBB => _shiftPressed ? '+' : '=',
        0xBC => _shiftPressed ? '<' : ',',
        0xBE => _shiftPressed ? '>' : '.',
        0xBF => _shiftPressed ? '?' : '/',
        0x20 => ' ',
        _ => null
    };
}
```

## Scope

- **Файл:** `Final_Test_Hybrid/Services/Scanner/RawInput/KeyboardInputMapper.cs`
- **Метод:** `MapSpecialKey()`
- **Изменения:** 1 файл, ~15 строк

## Risks

**Низкий риск:**
- Изолированное изменение в одном методе
- Обратная совместимость: символы без Shift работают как раньше
- Легко тестируется вручную

## Out of Scope

Не включено в этот fix (можно добавить позже при необходимости):
- OEM коды `0xBA` (`;:`), `0xC0` (`` `~ ``), `0xDB-0xDE` (скобки, кавычки)
- Shift-варианты для цифр (`!@#$%^&*()`)

## Testing

1. Сканировать штрихкод с `_` → должен корректно распознаться
2. Сканировать штрихкод с `-` → должен работать как раньше
3. Сканировать штрихкод с `=` → должен корректно распознаться
4. Сканировать штрихкод с `+` → должен работать как раньше
