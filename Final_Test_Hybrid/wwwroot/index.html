<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>WinFormsBlazor</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link href="css/text_indicator.css" rel="stylesheet">
    <link href="Final_Test_Hybrid.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/standard-base.css">
</head>

<body>

    <div id="app">Loading...</div>

    <div id="blazor-error-ui" data-nosnippet>
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.webview.js"></script>
    <script src="_content/Radzen.Blazor/Radzen.Blazor.js?v=@(typeof(Radzen.Colors).Assembly.GetName().Version)"></script>

    <script>
        window.outsideClickHandler = {
            add: (elementId, dotNetHelper) => {
                if (!window._outsideClickHandlers) window._outsideClickHandlers = {};
                
                const handler = (e) => {
                    const element = document.getElementById(elementId);
                    if (element && !element.contains(e.target)) {
                        dotNetHelper.invokeMethodAsync('CloseEdit');
                    }
                };
                
                window._outsideClickHandlers[elementId] = handler;
                document.addEventListener('click', handler);
            },
            remove: (elementId) => {
                if (window._outsideClickHandlers && window._outsideClickHandlers[elementId]) {
                    document.removeEventListener('click', window._outsideClickHandlers[elementId]);
                    delete window._outsideClickHandlers[elementId];
                }
            }
        };

        window.updateDialogTitle = (title) => {
            const titleElement = document.querySelector('.rz-dialog-titlebar .rz-dialog-title');
            if (titleElement) {
                titleElement.textContent = title;
            }
        };

        window.scrollGridToBottom = (containerId) => {
            const container = document.getElementById(containerId);
            if (!container) return;
            const scrollArea = container.querySelector('.rz-data-grid-data');
            if (scrollArea) {
                scrollArea.scrollTop = scrollArea.scrollHeight;
            }
        };

        window.floatingPanel = {
            _dragState: null,
            _dragDistanceThresholdPx: 5,
            _recentDragTtlMs: 250,
            _recentDragByElement: {},
            startDrag: (elementId, startX, startY) => {
                const el = document.getElementById(elementId);
                if (!el) return;

                const rect = el.getBoundingClientRect();
                const computedStyle = window.getComputedStyle(el);
                if (computedStyle.transform && computedStyle.transform !== 'none') {
                    el.style.left = rect.left + 'px';
                    el.style.top = rect.top + 'px';
                    el.style.right = 'auto';
                    el.style.bottom = 'auto';
                    el.style.transform = 'none';
                }

                window.floatingPanel._dragState = {
                    elementId: elementId,
                    startX: startX,
                    startY: startY,
                    offsetX: startX - rect.left,
                    offsetY: startY - rect.top,
                    hasMoved: false
                };

                document.addEventListener('mousemove', window.floatingPanel._onMouseMove);
                document.addEventListener('mouseup', window.floatingPanel._onMouseUp);
            },
            consumeRecentDrag: (elementId) => {
                const dragAt = window.floatingPanel._recentDragByElement[elementId];
                if (typeof dragAt !== 'number') {
                    return false;
                }

                delete window.floatingPanel._recentDragByElement[elementId];
                const elapsedMs = Date.now() - dragAt;
                return elapsedMs <= window.floatingPanel._recentDragTtlMs;
            },
            resetToCenter: (elementId) => {
                const el = document.getElementById(elementId);
                if (!el) return;

                el.style.left = '50%';
                el.style.top = '50%';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
                el.style.transform = 'translate(-50%, -50%)';
            },
            _onMouseMove: (e) => {
                const state = window.floatingPanel._dragState;
                if (!state) return;

                const el = document.getElementById(state.elementId);
                if (!el) return;

                if (!state.hasMoved) {
                    const distancePx = Math.hypot(e.clientX - state.startX, e.clientY - state.startY);
                    if (distancePx >= window.floatingPanel._dragDistanceThresholdPx) {
                        state.hasMoved = true;
                    }
                }

                const newX = e.clientX - state.offsetX;
                const newY = e.clientY - state.offsetY;

                el.style.left = newX + 'px';
                el.style.top = newY + 'px';
                el.style.right = 'auto';
                el.style.bottom = 'auto';
            },
            _onMouseUp: () => {
                const state = window.floatingPanel._dragState;
                if (state && state.hasMoved) {
                    window.floatingPanel._recentDragByElement[state.elementId] = Date.now();
                }

                window.floatingPanel._dragState = null;
                document.removeEventListener('mousemove', window.floatingPanel._onMouseMove);
                document.removeEventListener('mouseup', window.floatingPanel._onMouseUp);
            }
        };
    </script>
</body>

</html>
