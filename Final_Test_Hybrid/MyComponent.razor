@using Final_Test_Hybrid.Components.Archive
@using Final_Test_Hybrid.Components.Engineer
@using Final_Test_Hybrid.Components.Errors
@using Final_Test_Hybrid.Components.Indicators
@using Final_Test_Hybrid.Components.Results
@using Final_Test_Hybrid.Components.Main
@using Final_Test_Hybrid.Components.Overview
@using Final_Test_Hybrid.Components.Loading
@using Final_Test_Hybrid.Components.Schemes
@using Final_Test_Hybrid.Components.Main.Parameter
@using Final_Test_Hybrid.Services.OpcUa
@using Final_Test_Hybrid.Services.OpcUa.Connection
@using Final_Test_Hybrid.Services.Common.UI
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.Completion
@inject PlcSubscriptionState SubscriptionState
@inject OpcUaConnectionState ConnectionState
@inject BlazorDispatcherAccessor BlazorDispatcherAccessor
@inject TestCompletionUiState TestCompletionUiState
@inject RangeSliderUiState RangeSliderUiState
@implements IDisposable

<SubscriptionLoadingOverlay IsVisible="@SubscriptionState.IsInitializing" />

<RadzenDialog />
<RadzenNotification />
<RadzenTooltip />
<RadzenContextMenu />

<RadzenStack Orientation="Orientation.Vertical" Gap="0" class="app-stack-vertical">
    <div class="app-tabs-shell">
        <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="@selectedIndex" class="app-tabs-90">
            <Tabs>
                <RadzenTabsItem Text="Главный экран">
                    <div style="height: 100%; padding: 0 20px;">
                        <RadzenStack Orientation="Orientation.Vertical" Style="height: 100%; gap: 12px;">
                            <RadzenCard Class="header-card">
                                <ChildContent>
                                    <div class="header-grid">
                                        @* Блок 1: четыре поля *@
                                        <div class="header-block header-block-left">
                                            <Shift /> 
                                            <BoilerOrder />
                                        </div>

                                        @* Блок 2: тип + серийный + кнопка *@
                                        <div class="header-block header-block-middle">
                                            <BoilerInfo />
                                        </div>

                                        @* Блок 3: кнопки + имя оператора *@
                                        <div class="header-block header-block-right">
                                            <OperatorInfo />
                                        </div>

                                    </div>
                                </ChildContent>
                            </RadzenCard>

                            <div class="tab-content-wrapper">
                                <RadzenCard Class="header-card">
                                    <ChildContent>
                                        <div class="header-grid-parameter">
                                            <Gas />
                                            <Delta />
                                            <DHW />
                                            <CH />
                                            <Emissions />
                                            <GasP />
                                        </div>
                                    </ChildContent>
                                </RadzenCard>
                                @if (TestCompletionUiState.ShowResultImage)
                                {
                                    <div class="result-image-container">
                                        <div class="result-image-hint">
                                            <span class="hint-action">«Один шаг»</span> — закончить тест или <span class="hint-action">«Повтор»</span> для повтора теста
                                        </div>
                                        <img src="@TestCompletionUiState.ImagePath" alt="Test Result" />
                                    </div>
                                }
                                else if (RangeSliderUiState.HasActiveSliders)
                                {
                                    <RangeSliderDisplay />
                                }
                                else
                                {
                                    <MessageHelper />
                                    <TestSequenseGrid />
                                }
                            </div>
                        </RadzenStack>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Обзор">
                    <div class="app-tabs-shell app-tabs-shell-inside">
                        <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="@innerSelectedIndex"
                                    Style="height: 100%; width: 100%" class="scheme-tabs">
                            <Tabs>
                                <RadzenTabsItem Text="Газ">
                                    <GasScheme />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Отопление">
                                    <HeatingScheme />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Горячая вода">
                                    <HotWaterScheme />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Входы 1">
                                    <InputsPanel1 />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="RTD входы">
                                    <RtdInputsPanel />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Входы 2">
                                    <InputsPanel2 />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Выходы 1">
                                    <OutputsPanel1 />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Пн. выходы">
                                    <PneumaticOutputsPanel />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="Выходы 2">
                                    <OutputsPanel2 />
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="AI Cal Check">
                                    <div style="height: 100%; padding: 40px;">
                                        <AiCallCheck/>
                                    </div>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="RTD Cal Check">
                                    <div style="height: 100%; padding: 40px;">
                                        <RtdCalCheck/>
                                    </div>
                                </RadzenTabsItem>
                                <RadzenTabsItem Text="ПИД регуляторы">
                                    <div style="height: 100%; padding: 40px;">
                                        <PidRegulatorCheck/>
                                    </div>
                                </RadzenTabsItem>
                            </Tabs>
                        </RadzenTabs>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Ошибки">
                    <div style="height: 100%; padding: 0 20px;">
                        <ErrorsTab/>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Результаты">
                    <div style="height: 100%; padding: 0 20px;">
                        <TestResultsTab/>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Архив">
                    <div style="height: 100%; padding: 0 20px;">
                        <ArchiveGrid/>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Лог">
                    <div style="height: 100%; padding: 0 20px;">
                        <LogViewerTab/>
                    </div>
                </RadzenTabsItem>
                <RadzenTabsItem Text="Настройки">
                    <div style="height: 100%; padding: 0 20px;">
                        <MainEngineering/>
                    </div>
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </div>
    <div class="app-bottom-10">
        <!-- Левая часть: занимает всё место слева, контент прижат влево -->
        <div
            style="flex: 1; display: flex; align-items: center; min-width: 0; justify-content: flex-start; height: 100%;">
            <ErrorResetButton />

            <div class="app-bottom-10-content" style="margin-left: 100px">
                <AirOnIndicator />
                <EStopIndicator />
                <GasStopIndicator />
            </div>
        </div>

        <!-- Центр: занимает ровно столько, сколько контент, стоит по центру экрана -->
        <div class="app-bottom-10-content" style="flex: 0 0 auto; gap: 40px; margin-left: 230px">
            <TestTimerDisplay />
            <BoilerStatusDisplay />
            <ChangeoverTimerDisplay />
        </div>

        <!-- Правая часть: занимает всё место справа, контент прижат вправо -->
        <div
            style="flex: 1; display: flex; align-items: center; min-width: 0; justify-content: flex-end; height: 100%;">
            <div class="app-bottom-10-content" style="margin-right: 50px;">
                <DatabaseIndicator Label="БД Стенда" />
                <PlcIndicator Label="PLC"/>
                <SpringBootIndicator Label="Сервер"/>
                <ScannerIndicator Label="Сканнер"/>
            </div>
        </div>
    </div>
</RadzenStack>

@code {
    private int selectedIndex = 0;
    private int innerSelectedIndex = 0;
    private bool _disposed;

    protected override void OnInitialized()
    {
        BlazorDispatcherAccessor.Initialize(action => InvokeAsync(action), StateHasChanged);
        SubscriptionState.OnStateChanged += HandleStateChanged;
        ConnectionState.ConnectionStateChanged += HandleConnectionChanged;
        TestCompletionUiState.OnStateChanged += HandleTestCompletionChanged;
        RangeSliderUiState.OnStateChanged += HandleRangeSliderChanged;
    }

    private void HandleStateChanged()
    {
        if (_disposed) return;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleConnectionChanged(bool isConnected)
    {
        if (_disposed) return;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleTestCompletionChanged()
    {
        if (_disposed) return;
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleRangeSliderChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        _disposed = true;
        SubscriptionState.OnStateChanged -= HandleStateChanged;
        ConnectionState.ConnectionStateChanged -= HandleConnectionChanged;
        TestCompletionUiState.OnStateChanged -= HandleTestCompletionChanged;
        RangeSliderUiState.OnStateChanged -= HandleRangeSliderChanged;
    }
}
