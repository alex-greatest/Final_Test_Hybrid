@using Microsoft.AspNetCore.Components
@using System.Globalization

<div style="margin-bottom: 30px; padding: 10px 40px; background-color: #f5f5f5; border: 1px solid #ccc;">
    <div style="font-size: 24px; font-weight: bold; color: #555; margin-bottom: 8px; font-family: Arial, sans-serif;">
        @Label @(Unit != null ? $"({Unit})" : "")
    </div>

    <div style="position: relative;">
        @* Background track with color zones *@
        <div style="width: 100%; height: 36px; overflow: hidden; display: flex; border: 1px solid #999;">
            <div style="width: @(GreenStartPercent.ToString(CultureInfo.InvariantCulture))%; background-color: #e74c3c; height: 100%;"></div>
            <div style="width: @(GreenZoneWidth.ToString(CultureInfo.InvariantCulture))%; background-color: #2ecc71; height: 100%;"></div>
            <div style="width: @(RightRedZoneWidth.ToString(CultureInfo.InvariantCulture))%; background-color: #e74c3c; height: 100%;"></div>
        </div>

        @* Center line marker *@
        <div style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 2px; height: 42px; background-color: #333; z-index: 2;"></div>

        @* Value indicator - капля с значением *@
        <div style="position: absolute; top: -48px; left: @(ValuePercent.ToString(CultureInfo.InvariantCulture))%; transform: translateX(-50%); z-index: 3; display: flex; flex-direction: column; align-items: center;">
            @* Капля с числом *@
            <div style="background: linear-gradient(135deg, #333 0%, #111 100%);
                        color: #fff;
                        padding: 4px 10px;
                        border-radius: 8px;
                        font-size: 18px;
                        font-weight: bold;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                        border: 2px solid #fff;
                        min-width: 50px;
                        text-align: center;">
                @Value.ToString("F1", CultureInfo.InvariantCulture)
            </div>
            @* Линия-указатель *@
            <div style="width: 2px; height: 8px; background: linear-gradient(to bottom, #333, #666);"></div>
            @* Треугольник внизу *@
            <div style="width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 14px solid #666;"></div>
        </div>

        @* Tick marks *@
        <div style="position: relative; height: 8px;">
            @foreach (var tick in Ticks)
            {
                var percent = ((tick - Min) / Range) * 100;
                <div style="position: absolute; left: @(percent.ToString(CultureInfo.InvariantCulture))%; top: 0; transform: translateX(-50%); width: 1px; height: 8px; background-color: #555;"></div>
            }
        </div>

        @* Labels *@
        <div style="position: relative; height: 28px;">
            @foreach (var tick in Ticks)
            {
                var percent = ((tick - Min) / Range) * 100;
                <span style="position: absolute; left: @(percent.ToString(CultureInfo.InvariantCulture))%; transform: translateX(-50%); font-size: 20px; color: #555; font-family: Arial, sans-serif;">
                    @tick.ToString("F1", CultureInfo.InvariantCulture)
                </span>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string? Unit { get; set; }
    [Parameter] public double Min { get; set; }
    [Parameter] public double Max { get; set; }
    [Parameter] public double Value { get; set; }
    [Parameter] public double GreenZoneStart { get; set; }
    [Parameter] public double GreenZoneEnd { get; set; }
    [Parameter] public int TickCount { get; set; } = 20;

    private double Range => Max - Min;
    private double GreenStartPercent => ((GreenZoneStart - Min) / Range) * 100;
    private double GreenEndPercent => ((GreenZoneEnd - Min) / Range) * 100;
    private double GreenZoneWidth => GreenEndPercent - GreenStartPercent;
    private double RightRedZoneWidth => 100 - GreenEndPercent;
    
    private double ClampedValue => Math.Max(Min, Math.Min(Max, Value));
    private double ValuePercent => ((ClampedValue - Min) / Range) * 100;

    private List<double> Ticks
    {
        get
        {
            var ticks = new List<double>();
            for (var i = 0; i <= TickCount; i++)
            {
                ticks.Add(Min + (Range / TickCount) * i);
            }
            return ticks;
        }
    }
}
