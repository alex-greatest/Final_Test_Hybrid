@using Final_Test_Hybrid.Components.Main.Modals
@using Final_Test_Hybrid.Components.Engineer.Modals
@using Final_Test_Hybrid.Services.Common.Settings
@using Final_Test_Hybrid.Services.Database
@using Final_Test_Hybrid.Services.Main
@inject AppSettingsService AppSettingsService
@inject OrderState OrderState
@inject SuccessCountService SuccessCountService
@inject DialogService DialogService
@inject NotificationService NotificationService
@implements IDisposable

@if (AppSettingsService.UseMes)
{
    <div class="field-row">
        <RadzenLabel Text="Номер заказа"/>
        <RadzenTextBox Style="width:100%"
                       Value="@OrderNumberText"
                       ReadOnly="true"/>
    </div>
    <div class="field-row">
        <RadzenLabel Text="Котлов в заказе"/>
        <RadzenTextBox Style="width:100%"
                       Value="@AmountBoilerOrderText"
                       ReadOnly="true"/>
    </div>
    <div class="field-row">
        <RadzenLabel Text="Котлов сделано"/>
        <RadzenTextBox Style="width:100%"
                       Value="@AmountBoilerMadeOrderText"
                       ReadOnly="true"/>
    </div>
}
else
{
    <div style="grid-column: span 2; display: flex; align-items: center; gap: 16px;">
        <div class="field-row" style="flex: 0 0 calc((100% - 13px) / 2); max-width: calc((100% - 13px) / 2); min-width: 0;">
            <RadzenLabel Text="Успеш. тестов"/>
            <RadzenTextBox Style="width:100%"
                           Value="@SuccessCountText"
                           ReadOnly="true"/>
        </div>
        <RadzenButton Text="Изменить"
                      Style="font-size: 1.3rem; font-weight: 700; padding: 10px 12px;"
                      ButtonStyle="ButtonStyle.Secondary"
                      Click="@OpenEditDialogWithPassword"/>
        <RadzenButton Text="Сброс"
                      Style="font-size: 1.3rem; font-weight: 700; padding: 10px 12px;"
                      ButtonStyle="ButtonStyle.Danger"
                      Click="@ResetCountWithPassword"/>
    </div>
}

@code {
    private string OrderNumberText => OrderState.OrderNumber?.ToString() ?? "";
    private string AmountBoilerOrderText => OrderState.AmountBoilerOrder?.ToString() ?? "";
    private string AmountBoilerMadeOrderText => OrderState.AmountBoilerMadeOrder?.ToString() ?? "";
    private string SuccessCountText => _successCount.ToString();

    private long _successCount;

    protected override async Task OnInitializedAsync()
    {
        AppSettingsService.UseMesChanged += OnUseMesChanged;
        OrderState.OnChanged += OnStateChanged;
        SuccessCountService.OnCountChanged += OnCountChanged;

        await LoadSuccessCountAsync();
    }

    private async Task LoadSuccessCountAsync()
    {
        _successCount = await SuccessCountService.GetCountAsync();
    }

    private async void OnCountChanged()
    {
        try
        {
            await LoadSuccessCountAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
        }
        catch (InvalidOperationException)
        {
        }
    }

    private async void OnStateChanged()
    {
        try
        {
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
        }
        catch (InvalidOperationException)
        {
        }
    }

    private async void OnUseMesChanged(bool useMes)
    {
        try
        {
            if (!useMes)
            {
                await LoadSuccessCountAsync();
            }
            await InvokeAsync(StateHasChanged);
        }
        catch (ObjectDisposedException)
        {
        }
        catch (InvalidOperationException)
        {
        }
    }

    private async Task OpenEditDialog()
    {
        var result = await DialogService.OpenAsync<EditSuccessCountDialog>(
            "Редактирование счётчика",
            new Dictionary<string, object> { ["InitialValue"] = _successCount },
            new DialogOptions { Width = "300px" });

        if (result is long newValue)
        {
            await SaveCountAsync(newValue);
        }
    }

    private async Task SaveCountAsync(long newValue)
    {
        try
        {
            await SuccessCountService.UpdateCountAsync(newValue);
            _successCount = newValue;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", ex.Message);
        }
    }

    private async Task OpenEditDialogWithPassword()
    {
        var isAuthorized = await ShowPasswordDialog();
        if (!isAuthorized)
        {
            return;
        }

        await OpenEditDialog();
    }

    private async Task ResetCountWithPassword()
    {
        var isAuthorized = await ShowPasswordDialog();
        if (!isAuthorized)
        {
            return;
        }

        await ResetCount();
    }

    private async Task<bool> ShowPasswordDialog()
    {
        var result = await DialogService.OpenAsync<PasswordDialog>(
            "Введите пароль",
            new Dictionary<string, object>(),
            new DialogOptions { Width = "350px", CloseDialogOnOverlayClick = false });

        return result is true;
    }

    private async Task ResetCount()
    {
        var confirmed = await DialogService.Confirm(
            "Сбросить счётчик успешных тестов?",
            "Подтверждение",
            new ConfirmOptions { OkButtonText = "Да", CancelButtonText = "Нет" });

        if (confirmed == true)
        {
            await ResetCountAsync();
        }
    }

    private async Task ResetCountAsync()
    {
        try
        {
            await SuccessCountService.ResetCountAsync();
            _successCount = 0;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", ex.Message);
        }
    }

    public void Dispose()
    {
        AppSettingsService.UseMesChanged -= OnUseMesChanged;
        OrderState.OnChanged -= OnStateChanged;
        SuccessCountService.OnCountChanged -= OnCountChanged;
    }
}
