@using Final_Test_Hybrid.Services.SpringBoot.Operation
@inject DialogService DialogService
@inject NotificationService NotificationService
@implements IDisposable

<div class="rework-reason-dialog">
    <div class="field-group">
        <label class="field-label">Описание причины доработки/пропуска</label>
        <RadzenTextBox @bind-Value="_reason"
                       Placeholder="Введите причину доработки/пропуска"
                       Disabled="@_isLoading"
                       Style="width: 100%;" />
    </div>

    @if (!string.IsNullOrEmpty(_validationError))
    {
        <div class="validation-error">@_validationError</div>
    }

    @if (_isLoading)
    {
        <div class="loading-text">Отправка запроса...</div>
    }

    <div class="dialog-buttons">
        <RadzenButton Text="Отмена"
                      Icon="close"
                      Click="@OnCancel"
                      ButtonStyle="ButtonStyle.Light"
                      Disabled="@_isLoading"
                      class="cancel-button" />
        <RadzenButton Text="Подтвердить"
                      Click="@OnConfirm"
                      ButtonStyle="ButtonStyle.Primary"
                      IsBusy="@_isLoading"
                      class="confirm-button" />
    </div>
</div>

@code {
    [Parameter]
    public Func<string, Task<ReworkSubmitResult>>? OnSubmit { get; set; }
    private string _reason = string.Empty;
    private string _validationError = string.Empty;
    private bool _isLoading;
    private bool _disposed;
    private string? _lastError;

    private async Task OnConfirm()
    {
        if (!ValidateReason())
        {
            return;
        }
        await ProcessConfirmationAsync();
    }

    private async Task ProcessConfirmationAsync()
    {
        if (OnSubmit == null)
        {
            CloseWithReason();
            return;
        }
        await SubmitReasonAsync();
    }

    private bool ValidateReason()
    {
        _validationError = string.Empty;
        if (!string.IsNullOrWhiteSpace(_reason))
        {
            return true;
        }
        _validationError = "Введите причину доработки/пропуска";
        return false;
    }

    private void CloseWithReason()
    {
        DialogService.Close(_reason.Trim());
    }

    private async Task SubmitReasonAsync()
    {
        SetLoadingState(true);
        try
        {
            var result = await OnSubmit!(_reason.Trim());
            HandleSubmitResult(result);
        }
        finally
        {
            SetLoadingState(false);
        }
    }

    private void HandleSubmitResult(ReworkSubmitResult result)
    {
        if (result.IsSuccess)
        {
            DialogService.Close(result);
            return;
        }
        ShowSubmitError(result);
    }

    private void ShowSubmitError(ReworkSubmitResult result)
    {
        if (_disposed)
        {
            return;
        }
        _lastError = result.ErrorMessage ?? "Ошибка сервера";
        NotificationService.Notify(NotificationSeverity.Error, _lastError);
        StateHasChanged();
    }

    private void SetLoadingState(bool isLoading)
    {
        _isLoading = isLoading;
        if (!_disposed)
        {
            StateHasChanged();
        }
    }

    private void OnCancel()
    {
        if (OnSubmit == null)
        {
            DialogService.Close();
            return;
        }
        DialogService.Close(ReworkSubmitResult.Fail(_lastError ?? "Операция отменена"));
    }

    public void Dispose()
    {
        _disposed = true;
    }
}
