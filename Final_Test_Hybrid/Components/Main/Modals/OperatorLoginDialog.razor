@using Final_Test_Hybrid.Services.SpringBoot.Operator

<div class="operator-login-dialog">
    <div class="field-group">
        <label class="field-label">Логин</label>
        <RadzenTextBox @bind-Value="_login" Placeholder="Логин" Style="width: 100%;" />
    </div>
    <div class="field-group">
        <label class="field-label">Пароль</label>
        <RadzenPassword @bind-Value="_password" Placeholder="Пароль" Style="width: 100%;" />
    </div>
    @if (!string.IsNullOrEmpty(_validationError))
    {
        <div class="validation-error">@_validationError</div>
    }
    <div class="dialog-buttons">
        <RadzenButton Text="Подтвердить" Icon="check" Click="@OnConfirm"
                      ButtonStyle="ButtonStyle.Primary" IsBusy="_isLoading" />
    </div>
</div>

@code {
    [Inject]
    public required DialogService DialogService { get; set; }
    [Inject]
    public required NotificationService NotificationService { get; set; }
    [Inject]
    public required OperatorAuthService OperatorAuthService { get; set; }
    private string _login = string.Empty;
    private string _password = string.Empty;
    private string _validationError = string.Empty;
    private bool _isLoading;

    private async Task OnConfirm()
    {
        _validationError = string.Empty;
        if (!ValidateFields())
        {
            return;
        }
        await AuthenticateAsync();
    }

    private bool ValidateFields()
    {
        if (!string.IsNullOrWhiteSpace(_login) && !string.IsNullOrWhiteSpace(_password))
        {
            return true;
        }
        _validationError = "Заполните все поля";
        return false;
    }

    private async Task AuthenticateAsync()
    {
        _isLoading = true;
        StateHasChanged();
        var result = await OperatorAuthService.AuthenticateAsync(_login, _password);
        _isLoading = false;
        HandleResult(result);
    }

    private void HandleResult(OperatorAuthResult result)
    {
        if (result.Success)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Авторизация успешна");
            DialogService.Close(true);
            return;
        }
        NotificationService.Notify(NotificationSeverity.Error, result.ErrorMessage ?? "Неизвестная ошибка");
    }
}
