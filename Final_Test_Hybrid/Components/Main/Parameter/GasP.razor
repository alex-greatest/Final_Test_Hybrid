@using System.Globalization
@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa.Subscription
@inject OpcUaSubscription Subscription
@implements IAsyncDisposable

<div class="header-block-parameter param-gasp">
    <div class="field-row-parameter">
        <RadzenLabel Text="Gas_P"/>
        <RadzenTextBox Value="@_gasP" ReadOnly/>
    </div>
</div>

@code {
    private string _gasP = "N/A";
    private bool _disposed;
    [Parameter] public bool EmitCachedValueImmediately { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await Subscription.SubscribeAsync(MainScreenTags.GasP, OnGasPChanged, emitCachedValueImmediately: EmitCachedValueImmediately);
    }

    private async Task OnGasPChanged(object? value)
    {
        if (_disposed) return;
        _gasP = FormatValue(value);
        await InvokeAsync(StateHasChanged);
    }

    private static string FormatValue(object? value)
    {
        if (value == null) return "N/A";
        if (value is IFormattable formattable) return formattable.ToString("F3", CultureInfo.CurrentCulture);
        return value.ToString() ?? "N/A";
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        await Subscription.UnsubscribeAsync(MainScreenTags.GasP, OnGasPChanged, removeTag: false, ct: CancellationToken.None);
    }
}
