@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa.Subscription
@inject OpcUaSubscription Subscription
@implements IAsyncDisposable

<div class="header-block-parameter param-delta">
    <div class="field-row-parameter">
        <RadzenLabel Text="T-GAS"/>
        <RadzenTextBox Value="@_tGas" ReadOnly Style="width:100%"/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="CH.DeltaTemp"/>
        <RadzenTextBox Value="@_chDeltaTemp" ReadOnly Style="width:100%"/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="DHW.DeltaTemp"/>
        <RadzenTextBox Value="@_dhwDeltaTemp" ReadOnly Style="width:100%"/>
    </div>
</div>

@code {
    private string _tGas = "N/A";
    private string _chDeltaTemp = "N/A";
    private string _dhwDeltaTemp = "N/A";
    private bool _disposed;

    protected override async Task OnInitializedAsync()
    {
        await Subscription.SubscribeAsync(MainScreenTags.GasTag, OnTGasChanged);
        await Subscription.SubscribeAsync(MainScreenTags.ChDeltaTemp, OnChDeltaTempChanged);
        await Subscription.SubscribeAsync(MainScreenTags.DhwDeltaTemp, OnDhwDeltaTempChanged);
    }

    private async Task OnTGasChanged(object? value)
    {
        if (_disposed) return;
        _tGas = FormatValue(value, "  °C");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnChDeltaTempChanged(object? value)
    {
        if (_disposed) return;
        _chDeltaTemp = FormatValue(value, "  °C");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnDhwDeltaTempChanged(object? value)
    {
        if (_disposed) return;
        _dhwDeltaTemp = FormatValue(value, "  °C");
        await InvokeAsync(StateHasChanged);
    }

    private static string FormatValue(object? value, string unit)
    {
        if (value == null) return "N/A";
        if (value is IFormattable formattable) return $"{formattable.ToString("F3", null)}{unit}";
        return $"{value}{unit}";
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        await Subscription.UnsubscribeAsync(MainScreenTags.GasTag, OnTGasChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.ChDeltaTemp, OnChDeltaTempChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.DhwDeltaTemp, OnDhwDeltaTempChanged, removeTag: false, ct: CancellationToken.None);
    }
}
