@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa.Subscription
@using Final_Test_Hybrid.Services.Diagnostic.Services
@using Final_Test_Hybrid.Services.Diagnostic.Protocol.CommandQueue
@inject OpcUaSubscription Subscription
@inject BoilerTemperatureService BoilerTemperatureService
@inject IModbusDispatcher Dispatcher
@implements IAsyncDisposable

<div class="header-block-parameter param-dhw">
    <div class="field-row-parameter">
        <RadzenLabel Text="Q-DHW"/>
        <RadzenTextBox Value="@_qDhw" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="P-DHW"/>
        <RadzenTextBox Value="@_pDhw" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="T-DHW IN"/>
        <RadzenTextBox Value="@_tDhwIn" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="T-DHW OUT"/>
        <RadzenTextBox Value="@_tDhwOut" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="tDHW котла"/>
        <RadzenTextBox Value="@_tDhwBoiler" ReadOnly/>
    </div>
</div>

@code {
    private string _qDhw = "N/A";
    private string _pDhw = "N/A";
    private string _tDhwIn = "N/A";
    private string _tDhwOut = "N/A";
    private string _tDhwBoiler = "N/A";
    private PeriodicTimer? _modbusTimer;
    private CancellationTokenSource? _cts;
    private Task? _pollingTask;
    private volatile bool _disposed;

    protected override async Task OnInitializedAsync()
    {
        await Subscription.SubscribeAsync(MainScreenTags.DhwFs, OnQDhwChanged);
        await Subscription.SubscribeAsync(MainScreenTags.DhwPes, OnPDhwChanged);
        await Subscription.SubscribeAsync(MainScreenTags.DhwTes, OnTDhwInChanged);
        await Subscription.SubscribeAsync(MainScreenTags.DhwTus, OnTDhwOutChanged);

        Dispatcher.Connected += OnDispatcherConnected;
        Dispatcher.Disconnecting += OnDispatcherDisconnecting;

        if (Dispatcher.IsStarted && Dispatcher.IsConnected)
        {
            StartModbusPolling();
        }
    }

    /// <summary>
    /// Обработчик события подключения диспетчера.
    /// </summary>
    private void OnDispatcherConnected()
    {
        if (_disposed) return;
        _ = InvokeAsync(() =>
        {
            if (_disposed) return;
            StartModbusPolling();
            StateHasChanged();
        });
    }

    /// <summary>
    /// Обработчик события отключения диспетчера.
    /// </summary>
    private Task OnDispatcherDisconnecting()
    {
        if (_disposed) return Task.CompletedTask;
        _ = InvokeAsync(() =>
        {
            if (_disposed) return;
            StopModbusPolling();
            ResetModbusValues();
            StateHasChanged();
        });
        return Task.CompletedTask;
    }

    /// <summary>
    /// Сбрасывает значения Modbus в начальное состояние.
    /// </summary>
    private void ResetModbusValues()
    {
        _tDhwBoiler = "N/A";
    }

    /// <summary>
    /// Останавливает polling Modbus.
    /// </summary>
    private void StopModbusPolling()
    {
        _cts?.Cancel();
    }

    /// <summary>
    /// Запускает polling Modbus.
    /// </summary>
    private void StartModbusPolling()
    {
        if (!Dispatcher.IsConnected) return;
        if (_pollingTask != null && !_pollingTask.IsCompleted) return;

        _cts?.Dispose();
        _cts = new CancellationTokenSource();
        _modbusTimer?.Dispose();
        _modbusTimer = new PeriodicTimer(TimeSpan.FromSeconds(2));
        _pollingTask = PollModbusAsync(_cts.Token);
    }

    /// <summary>
    /// Цикл периодического опроса Modbus.
    /// </summary>
    private async Task PollModbusAsync(CancellationToken ct)
    {
        var timer = _modbusTimer;
        var cts = _cts;
        try
        {
            while (timer != null && await timer.WaitForNextTickAsync(ct).ConfigureAwait(false))
            {
                var result = await BoilerTemperatureService.ReadDHWTemperatureAsync(ct).ConfigureAwait(false);
                _tDhwBoiler = result.Success ? $"{result.Value}  °C" : "N/A";
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (OperationCanceledException)
        {
            // Нормальное завершение при отмене
        }
        catch (Exception)
        {
            ResetModbusValues();
            await InvokeAsync(StateHasChanged);
        }
        finally
        {
            if (ReferenceEquals(timer, _modbusTimer))
            {
                _modbusTimer?.Dispose();
                _modbusTimer = null;
            }
            if (ReferenceEquals(cts, _cts))
            {
                _cts?.Dispose();
                _cts = null;
            }
        }
    }

    private async Task OnQDhwChanged(object? value)
    {
        _qDhw = FormatValue(value, "  л/мин");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPDhwChanged(object? value)
    {
        _pDhw = FormatValue(value, "  бар");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTDhwInChanged(object? value)
    {
        _tDhwIn = FormatValue(value, "  °C");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnTDhwOutChanged(object? value)
    {
        _tDhwOut = FormatValue(value, "  °C");
        await InvokeAsync(StateHasChanged);
    }

    private static string FormatValue(object? value, string unit) =>
        value != null ? $"{value}{unit}" : "N/A";

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        Dispatcher.Connected -= OnDispatcherConnected;
        Dispatcher.Disconnecting -= OnDispatcherDisconnecting;

        StopModbusPolling();

        if (_pollingTask != null)
        {
            try { await _pollingTask; } catch { /* ignored */ }
        }

        _modbusTimer?.Dispose();
        _cts?.Dispose();

        await Subscription.UnsubscribeAsync(MainScreenTags.DhwFs, OnQDhwChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.DhwPes, OnPDhwChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.DhwTes, OnTDhwInChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.DhwTus, OnTDhwOutChanged, removeTag: false, ct: CancellationToken.None);
    }
}
