@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa.Subscription
@inject OpcUaSubscription Subscription
@implements IAsyncDisposable

<div class="header-block-parameter param-emissions">
    <div class="field-row-parameter">
        <RadzenLabel Text="CO"/>
        <RadzenTextBox Value="@_co" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="CO2"/>
        <RadzenTextBox Value="@_co2" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="Gas_POG1"/>
        <RadzenTextBox Value="@_gasPog1" ReadOnly/>
    </div>
    <div class="field-row-parameter">
        <RadzenLabel Text="P атм"/>
        <RadzenTextBox Value="@_pAtm" ReadOnly/>
    </div>
</div>

@code {
    private string _co = "N/A";
    private string _co2 = "N/A";
    private string _gasPog1 = "N/A";
    private string _pAtm = "N/A";

    protected override async Task OnInitializedAsync()
    {
        await Subscription.SubscribeAsync(MainScreenTags.FaCo, OnCoChanged);
        await Subscription.SubscribeAsync(MainScreenTags.FaCo2, OnCo2Changed);
        await Subscription.SubscribeAsync(MainScreenTags.GasPog1, OnGasPog1Changed);
        await Subscription.SubscribeAsync(MainScreenTags.GasPa, OnPAtmChanged);
    }

    private async Task OnCoChanged(object? value)
    {
        _co = FormatValue(value, "  ppm");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCo2Changed(object? value)
    {
        _co2 = FormatValue(value, "  %");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnGasPog1Changed(object? value)
    {
        _gasPog1 = FormatValue(value, "  м³/ч");
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnPAtmChanged(object? value)
    {
        _pAtm = FormatValue(value, "  мбар");
        await InvokeAsync(StateHasChanged);
    }

    private static string FormatValue(object? value, string unit) =>
        value != null ? $"{value}{unit}" : "N/A";

    public async ValueTask DisposeAsync()
    {
        await Subscription.UnsubscribeAsync(MainScreenTags.FaCo, OnCoChanged, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.FaCo2, OnCo2Changed, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.GasPog1, OnGasPog1Changed, removeTag: false, ct: CancellationToken.None);
        await Subscription.UnsubscribeAsync(MainScreenTags.GasPa, OnPAtmChanged, removeTag: false, ct: CancellationToken.None);
    }
}
