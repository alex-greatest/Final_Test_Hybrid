@using Final_Test_Hybrid.Components.Main.Modals
@using Final_Test_Hybrid.Models.Steps
@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.SpringBoot.Operation
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.Scanning
@using Final_Test_Hybrid.Services.Steps.Validation
@inject ScanStepManager ScanStepManager
@inject BoilerState BoilerState
@inject TestSequenseService TestSequenseService
@inject DialogService DialogService
@inject ReworkDialogService ReworkDialogService
@implements IDisposable

<div class="field-row field-row-middle">
    <RadzenLabel Text="Тип котла"/>
    <RadzenTextBox Style="width:100%"
                   Value="@(BoilerState.BoilerTypeCycle?.Type ?? "")"
                   ReadOnly="true"/>
</div>
<div class="field-row field-row-middle">
    <RadzenLabel Text="Серийный номер"/>
    <RadzenTextBox
        Style="width:100%"
        Value="@GetDisplayValue()"
        ReadOnly="@ScanStepManager.IsProcessing"
        @oninput="OnInput"
        @onkeydown="OnKeyDown"
        Placeholder="@_placeholder"/>
</div>

@code {
    private string _manualInput = "";
    private bool _disposed;
    private string _placeholder = "";

    protected override void OnInitialized()
    {
        BoilerState.OnChanged += OnBoilerStateChanged;
        TestSequenseService.OnDataChanged += OnStepChanged;
        ScanStepManager.OnChange += OnScanStateChanged;
        ScanStepManager.OnMissingPlcTagsDialogRequested += ShowMissingPlcTagsDialogAsync;
        ScanStepManager.OnMissingRequiredTagsDialogRequested += ShowMissingRequiredTagsDialogAsync;
        ScanStepManager.OnUnknownStepsDialogRequested += ShowUnknownStepsDialogAsync;
        ScanStepManager.OnMissingRecipesDialogRequested += ShowMissingRecipesDialogAsync;
        ScanStepManager.OnRecipeWriteErrorDialogRequested += ShowRecipeWriteErrorDialogAsync;
        ScanStepManager.OnReworkDialogRequested += HandleReworkDialogAsync;
    }

    private string GetDisplayValue() => BoilerState.SerialNumber ?? _manualInput;

    private void OnStepChanged()
    {
        var currentStep = TestSequenseService.Data.FirstOrDefault();
        var isScanStep = currentStep?.Module is "Сканирование штрихкода" or "Сканирование штрихкода MES";
        _placeholder = isScanStep ? "Отсканируйте или введите" : "";
        InvokeIfNotDisposed(StateHasChanged);
    }

    private void OnScanStateChanged() => InvokeIfNotDisposed(StateHasChanged);

    private void OnInput(ChangeEventArgs e) => _manualInput = e.Value?.ToString() ?? "";

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter" || string.IsNullOrEmpty(_manualInput))
        {
            return;
        }
        await ScanStepManager.ProcessBarcodeAsync(_manualInput);
        _manualInput = "";
    }

    private void OnBoilerStateChanged()
    {
        InvokeIfNotDisposed(ClearManualInput);
    }

    private void ClearManualInput()
    {
        _manualInput = "";
        StateHasChanged();
    }

    private void InvokeIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        InvokeAsync(() => ExecuteIfNotDisposed(action));
    }

    private void ExecuteIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        action();
    }

    private async Task ShowMissingPlcTagsDialogAsync(IReadOnlyList<string> missingTags)
    {
        await ShowMissingTagsDialogAsync(
            "Отсутствующие теги для PLC",
            missingTags,
            $"В PLC DB_Recipe отсутствует тегов: {missingTags.Count}");
    }

    private async Task ShowMissingRequiredTagsDialogAsync(IReadOnlyList<string> missingTags)
    {
        await ShowMissingTagsDialogAsync(
            "Отсутствующие обязательные теги",
            missingTags,
            $"В рецептах БД отсутствуют обязательные теги: {missingTags.Count}");
    }

    private async Task ShowMissingTagsDialogAsync(string title, IReadOnlyList<string> missingTags, string infoMessage)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<MissingTagsDialog>(
                title,
                new Dictionary<string, object>
                {
                    { "MissingTags", missingTags.ToList() },
                    { "InfoMessage", infoMessage }
                },
                CreateFullScreenDialogOptions("missing-tags-dialog-window"));
        });
    }

    private async Task ShowUnknownStepsDialogAsync(IReadOnlyList<UnknownStepInfo> unknownSteps)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<UnknownStepsDialog>(
                "Неизвестные шаги в последовательности",
                new Dictionary<string, object>
                {
                    { "UnknownSteps", unknownSteps.ToList() }
                },
                CreateFullScreenDialogOptions("unknown-steps-dialog-window"));
        });
    }

    private async Task ShowMissingRecipesDialogAsync(IReadOnlyList<MissingRecipeInfo> missingRecipes)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<MissingRecipesDialog>(
                "Отсутствующие рецепты",
                new Dictionary<string, object>
                {
                    { "MissingRecipes", missingRecipes.ToList() }
                },
                CreateFullScreenDialogOptions("missing-recipes-dialog-window"));
        });
    }

    private async Task ShowRecipeWriteErrorDialogAsync(IReadOnlyList<RecipeWriteErrorInfo> errors)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<RecipeWriteErrorDialog>(
                "Ошибка записи рецепта в PLC",
                new Dictionary<string, object>
                {
                    { "Errors", errors.ToList() }
                },
                CreateFullScreenDialogOptions("recipe-write-error-dialog-window"));
        });
    }

    private static DialogOptions CreateFullScreenDialogOptions(string cssClass)
    {
        return new DialogOptions
        {
            Width = "95vw",
            Height = "90vh",
            CloseDialogOnOverlayClick = false,
            CssClass = cssClass
        };
    }

    private Task<ReworkFlowResult> HandleReworkDialogAsync(
        string errorMessage,
        Func<string, string, Task<ReworkSubmitResult>> executeRework)
    {
        return ReworkDialogService.ExecuteReworkFlowAsync(errorMessage, executeRework);
    }

    public void Dispose()
    {
        _disposed = true;
        BoilerState.OnChanged -= OnBoilerStateChanged;
        TestSequenseService.OnDataChanged -= OnStepChanged;
        ScanStepManager.OnChange -= OnScanStateChanged;
        ScanStepManager.OnMissingPlcTagsDialogRequested -= ShowMissingPlcTagsDialogAsync;
        ScanStepManager.OnMissingRequiredTagsDialogRequested -= ShowMissingRequiredTagsDialogAsync;
        ScanStepManager.OnUnknownStepsDialogRequested -= ShowUnknownStepsDialogAsync;
        ScanStepManager.OnMissingRecipesDialogRequested -= ShowMissingRecipesDialogAsync;
        ScanStepManager.OnRecipeWriteErrorDialogRequested -= ShowRecipeWriteErrorDialogAsync;
        ScanStepManager.OnReworkDialogRequested -= HandleReworkDialogAsync;
    }
}
