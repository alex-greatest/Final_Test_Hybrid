@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.Scanner
@using Final_Test_Hybrid.Services.Steps.Execution
@inject SequenceValidationState ValidationState
@inject BarcodeScanService BarcodeScanService
@inject BoilerState BoilerState
@inject TooltipService TooltipService
@implements IDisposable

<div class="field-row field-row-middle">
    <RadzenLabel Text="Тип котла"/>
    <RadzenTextBox Style="width:100%" ReadOnly="true"/>
</div>
<div class="field-row field-row-middle">
    <RadzenLabel Text="Серийный номер"/>
    <div style="display:flex; align-items:center; width:100%">
        <RadzenTextBox
            Style="flex:1"
            Value="@GetDisplayValue()"
            @oninput="OnInput"
            @onkeydown="OnKeyDown"
            Placeholder="Отсканируйте или введите"/>
        @if (!string.IsNullOrEmpty(_lastError))
        {
            <RadzenIcon Icon="error"
                        Style="color:var(--rz-danger); margin-left:8px; cursor:help"
                        @ref="_errorIconRef"
                        MouseEnter="@ShowErrorTooltip"/>
        }
    </div>
</div>

@code {
    private string? _lastError;
    private string _manualInput = "";
    private RadzenIcon? _errorIconRef;

    protected override void OnInitialized()
    {
        ValidationState.OnErrorChanged += OnValidationChanged;
        BoilerState.OnChanged += OnBoilerStateChanged;
        _lastError = ValidationState.LastError;
    }

    private string GetDisplayValue()
    {
        return BoilerState.SerialNumber ?? _manualInput;
    }

    private void OnInput(ChangeEventArgs e)
    {
        _manualInput = e.Value?.ToString() ?? "";
    }

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if (!IsEnterKeyWithInput(e))
        {
            return;
        }
        SubmitManualBarcode();
    }

    private bool IsEnterKeyWithInput(KeyboardEventArgs e)
    {
        return e.Key == "Enter" && !string.IsNullOrEmpty(_manualInput);
    }

    private void SubmitManualBarcode()
    {
        BarcodeScanService.ProcessBarcode(_manualInput);
        _manualInput = "";
    }

    private void OnValidationChanged()
    {
        _lastError = ValidationState.LastError;
        InvokeAsync(StateHasChanged);
    }

    private void OnBoilerStateChanged()
    {
        _manualInput = "";
        InvokeAsync(StateHasChanged);
    }

    private void ShowErrorTooltip(ElementReference element)
    {
        if (string.IsNullOrEmpty(_lastError))
        {
            return;
        }
        TooltipService.Open(element, _lastError, new TooltipOptions
        {
            Duration = 5000,
            Position = TooltipPosition.Left
        });
    }

    public void Dispose()
    {
        ValidationState.OnErrorChanged -= OnValidationChanged;
        BoilerState.OnChanged -= OnBoilerStateChanged;
    }
}
