@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.Scanner
@using Final_Test_Hybrid.Services.Steps.Execution
@inject SequenceValidationState ValidationState
@inject BarcodeScanService BarcodeScanService
@inject BoilerState BoilerState
@inject TooltipService TooltipService
@inject NotificationService NotificationService
@implements IDisposable

<div class="field-row field-row-middle">
    <RadzenLabel Text="Тип котла"/>
    <RadzenTextBox Style="width:100%" ReadOnly="true"/>
</div>
<div class="field-row field-row-middle">
    <RadzenLabel Text="Серийный номер"/>
    <div style="display:flex; align-items:center; width:100%">
        <RadzenTextBox
            Style="flex:1"
            Value="@GetDisplayValue()"
            @oninput="OnInput"
            @onkeydown="OnKeyDown"
            Placeholder="Отсканируйте или введите"/>
        @if (!string.IsNullOrEmpty(_lastError))
        {
            <RadzenIcon Icon="error"
                        Style="color:var(--rz-danger); margin-left:8px; cursor:help"
                        @ref="_errorIconRef"
                        MouseEnter="@ShowErrorTooltip"/>
        }
    </div>
</div>

@code {
    private string? _lastError;
    private string _manualInput = "";
    private RadzenIcon? _errorIconRef;
    private bool _disposed;

    protected override void OnInitialized()
    {
        ValidationState.OnErrorChanged += OnValidationChanged;
        BoilerState.OnChanged += OnBoilerStateChanged;
    }

    private string GetDisplayValue() => BoilerState.SerialNumber ?? _manualInput;

    private void OnInput(ChangeEventArgs e) => _manualInput = e.Value?.ToString() ?? "";

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter" || string.IsNullOrEmpty(_manualInput))
        {
            return;
        }
        BarcodeScanService.ProcessBarcode(_manualInput);
        _manualInput = "";
    }

    private void OnValidationChanged(string? error)
    {
        InvokeIfNotDisposed(() => ApplyValidationError(error));
    }

    private void ApplyValidationError(string? error)
    {
        _lastError = error;
        if (!string.IsNullOrEmpty(error))
        {
            ShowErrorNotification(error);
        }
        StateHasChanged();
    }

    private void OnBoilerStateChanged()
    {
        InvokeIfNotDisposed(ClearManualInput);
    }

    private void ClearManualInput()
    {
        _manualInput = "";
        StateHasChanged();
    }

    private void InvokeIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        InvokeAsync(() => ExecuteIfNotDisposed(action));
    }

    private void ExecuteIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        action();
    }

    private void ShowErrorNotification(string error)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Ошибка при сканировании",
            Detail = error,
            Duration = 10000
        });
    }

    private void ShowErrorTooltip(ElementReference element)
    {
        if (string.IsNullOrEmpty(_lastError))
        {
            return;
        }
        TooltipService.Open(element, _lastError, new TooltipOptions
        {
            Duration = 0,
            Position = TooltipPosition.Left
        });
    }

    public void Dispose()
    {
        _disposed = true;
        ValidationState.OnErrorChanged -= OnValidationChanged;
        BoilerState.OnChanged -= OnBoilerStateChanged;
    }
}
