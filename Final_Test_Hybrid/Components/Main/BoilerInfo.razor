@using Final_Test_Hybrid.Components.Main.Modals
@using Final_Test_Hybrid.Models.Steps
@using Final_Test_Hybrid.Services.Common.Settings
@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.Main.PlcReset
@using Final_Test_Hybrid.Services.SpringBoot.Operation
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.ErrorCoordinator
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.PreExecution
@using Final_Test_Hybrid.Services.Steps.Validation
@inject PreExecutionCoordinator PreExecution
@inject BoilerState BoilerState
@inject TestSequenseService TestSequenseService
@inject DialogService DialogService
@inject ReworkDialogService ReworkDialogService
@inject AppSettingsService AppSettingsService
@inject ErrorCoordinator ErrorCoordinator
@inject PlcResetCoordinator PlcResetCoordinator
@implements IDisposable

<div class="field-row field-row-middle">
    <RadzenLabel Text="Тип котла"/>
    <RadzenTextBox Style="width:100%"
                   Value="@(BoilerState.BoilerTypeCycle?.Type ?? "")"
                   ReadOnly="true"/>
</div>
<div class="field-row field-row-middle">
    <RadzenLabel Text="Серийный номер"/>
    <div style="position: relative; width: 100%;">
        <RadzenTextBox
            Style="width: 100%; padding-right: 30px;"
            Value="@GetDisplayValue()"
            ReadOnly="@IsFieldReadOnly"
            @oninput="OnInput"
            @onkeydown="OnKeyDown"
            Placeholder="@Placeholder"/>
        @if (!IsFieldReadOnly && !string.IsNullOrEmpty(GetDisplayValue()))
        {
            <RadzenIcon
                Icon="close"
                Style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--rz-text-tertiary-color);"
                @onclick="ClearSerialNumber"/>
        }
    </div>
</div>

@code {
    private string _manualInput = "";
    private bool _disposed;
    private const string PlaceholderText = "Отсканируйте или введите";

    private bool IsOnActiveScanStep => TestSequenseService.IsOnActiveScanStep;
    private bool IsFieldReadOnly => !PreExecution.IsAcceptingInput || !IsOnActiveScanStep;
    private string Placeholder => IsOnActiveScanStep ? PlaceholderText : "";

    protected override void OnInitialized()
    {
        BoilerState.OnChanged += OnBoilerStateChanged;
        TestSequenseService.OnDataChanged += OnDataChanged;
        PreExecution.OnStateChanged += OnScanStateChanged;
        PreExecution.OnMissingPlcTagsDialogRequested += ShowMissingPlcTagsDialogAsync;
        PreExecution.OnMissingRequiredTagsDialogRequested += ShowMissingRequiredTagsDialogAsync;
        PreExecution.OnUnknownStepsDialogRequested += ShowUnknownStepsDialogAsync;
        PreExecution.OnMissingRecipesDialogRequested += ShowMissingRecipesDialogAsync;
        PreExecution.OnRecipeWriteErrorDialogRequested += ShowRecipeWriteErrorDialogAsync;
        PreExecution.OnReworkDialogRequested += HandleReworkDialogAsync;
        AppSettingsService.UseMesChanged += OnUseMesChanged;
        ErrorCoordinator.OnReset += CloseDialogs;
        PlcResetCoordinator.OnForceStop += CloseDialogs;
    }

    private void CloseDialogs()
    {
        _ = InvokeAsync(() => DialogService.Close());
    }

    private string GetDisplayValue() => BoilerState.SerialNumber ?? PreExecution.CurrentBarcode ?? _manualInput;

    private void OnDataChanged() => InvokeIfNotDisposed(StateHasChanged);

    private void OnScanStateChanged() => InvokeIfNotDisposed(StateHasChanged);

    private void OnUseMesChanged(bool _)
    {
        _manualInput = "";
        BoilerState.Clear();
        PreExecution.ClearBarcode();
        InvokeIfNotDisposed(StateHasChanged);
    }

    private void OnInput(ChangeEventArgs e) => _manualInput = e.Value?.ToString() ?? "";

    private void OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter" || IsFieldReadOnly || string.IsNullOrEmpty(_manualInput)) return;

        PreExecution.SubmitBarcode(_manualInput);
    }

    private void OnBoilerStateChanged()
    {
        if (BoilerState.SerialNumber != null)
        {
            InvokeIfNotDisposed(ClearManualInput);
        }
        else
        {
            InvokeIfNotDisposed(StateHasChanged);
        }
    }

    private void ClearManualInput()
    {
        _manualInput = "";
        StateHasChanged();
    }

    private void ClearSerialNumber()
    {
        _manualInput = "";
        PreExecution.ClearBarcode();
        StateHasChanged();
    }

    private void InvokeIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        InvokeAsync(() => ExecuteIfNotDisposed(action));
    }

    private void ExecuteIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        action();
    }

    private async Task ShowMissingPlcTagsDialogAsync(IReadOnlyList<string> missingTags)
    {
        await ShowMissingTagsDialogAsync(
            "Отсутствующие теги для PLC",
            missingTags,
            $"В PLC DB_Recipe отсутствует тегов: {missingTags.Count}");
    }

    private async Task ShowMissingRequiredTagsDialogAsync(IReadOnlyList<string> missingTags)
    {
        await ShowMissingTagsDialogAsync(
            "Отсутствующие обязательные теги",
            missingTags,
            $"В рецептах БД отсутствуют обязательные теги: {missingTags.Count}");
    }

    private async Task ShowMissingTagsDialogAsync(string title, IReadOnlyList<string> missingTags, string infoMessage)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<MissingTagsDialog>(
                title,
                new Dictionary<string, object>
                {
                    { "MissingTags", missingTags.ToList() },
                    { "InfoMessage", infoMessage }
                },
                CreateFullScreenDialogOptions("missing-tags-dialog-window"));
        });
    }

    private async Task ShowUnknownStepsDialogAsync(IReadOnlyList<UnknownStepInfo> unknownSteps)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<UnknownStepsDialog>(
                "Неизвестные шаги в последовательности",
                new Dictionary<string, object>
                {
                    { "UnknownSteps", unknownSteps.ToList() }
                },
                CreateFullScreenDialogOptions("unknown-steps-dialog-window"));
        });
    }

    private async Task ShowMissingRecipesDialogAsync(IReadOnlyList<MissingRecipeInfo> missingRecipes)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<MissingRecipesDialog>(
                "Отсутствующие рецепты",
                new Dictionary<string, object>
                {
                    { "MissingRecipes", missingRecipes.ToList() }
                },
                CreateFullScreenDialogOptions("missing-recipes-dialog-window"));
        });
    }

    private async Task ShowRecipeWriteErrorDialogAsync(IReadOnlyList<RecipeWriteErrorInfo> errors)
    {
        await InvokeAsync(async () =>
        {
            await DialogService.OpenAsync<RecipeWriteErrorDialog>(
                "Ошибка записи рецепта в PLC",
                new Dictionary<string, object>
                {
                    { "Errors", errors.ToList() }
                },
                CreateFullScreenDialogOptions("recipe-write-error-dialog-window"));
        });
    }

    private static DialogOptions CreateFullScreenDialogOptions(string cssClass)
    {
        return new DialogOptions
        {
            Width = "95vw",
            Height = "90vh",
            ShowClose = false,
            CloseDialogOnOverlayClick = false,
            CloseDialogOnEsc = false,
            CssClass = cssClass
        };
    }

    private Task<ReworkFlowResult> HandleReworkDialogAsync(
        string errorMessage,
        Func<string, string, Task<ReworkSubmitResult>> executeRework)
    {
        return ReworkDialogService.ExecuteReworkFlowAsync(errorMessage, executeRework);
    }

    public void Dispose()
    {
        _disposed = true;
        BoilerState.OnChanged -= OnBoilerStateChanged;
        TestSequenseService.OnDataChanged -= OnDataChanged;
        PreExecution.OnStateChanged -= OnScanStateChanged;
        PreExecution.OnMissingPlcTagsDialogRequested -= ShowMissingPlcTagsDialogAsync;
        PreExecution.OnMissingRequiredTagsDialogRequested -= ShowMissingRequiredTagsDialogAsync;
        PreExecution.OnUnknownStepsDialogRequested -= ShowUnknownStepsDialogAsync;
        PreExecution.OnMissingRecipesDialogRequested -= ShowMissingRecipesDialogAsync;
        PreExecution.OnRecipeWriteErrorDialogRequested -= ShowRecipeWriteErrorDialogAsync;
        PreExecution.OnReworkDialogRequested -= HandleReworkDialogAsync;
        AppSettingsService.UseMesChanged -= OnUseMesChanged;
        ErrorCoordinator.OnReset -= CloseDialogs;
        PlcResetCoordinator.OnForceStop -= CloseDialogs;
    }
}
