@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.Scanner
@using Final_Test_Hybrid.Services.Steps.Execution
@using Final_Test_Hybrid.Services.Steps.Manage
@inject SequenceValidationState ValidationState
@inject BarcodeScanService BarcodeScanService
@inject BoilerState BoilerState
@inject NotificationService NotificationService
@inject TestSequenseService TestSequenseService
@implements IDisposable

<div class="field-row field-row-middle">
    <RadzenLabel Text="Тип котла"/>
    <RadzenTextBox Style="width:100%" ReadOnly="true"/>
</div>
<div class="field-row field-row-middle">
    <RadzenLabel Text="Серийный номер"/>
    <RadzenTextBox
        Style="width:100%"
        Value="@GetDisplayValue()"
        @oninput="OnInput"
        @onkeydown="OnKeyDown"
        Placeholder="@_placeholder"/>
</div>

@code {
    private string _manualInput = "";
    private bool _disposed;
    private string _placeholder = "";

    protected override void OnInitialized()
    {
        ValidationState.OnErrorChanged += OnValidationChanged;
        BoilerState.OnChanged += OnBoilerStateChanged;
        TestSequenseService.OnDataChanged += OnStepChanged;
    }

    private string GetDisplayValue() => BoilerState.SerialNumber ?? _manualInput;

    private void OnStepChanged()
    {
        var currentStep = TestSequenseService.Data.FirstOrDefault();
        var isScanStep = currentStep?.Module is "Сканирование штрихкода" or "Сканирование штрихкода MES";
        _placeholder = isScanStep ? "Отсканируйте или введите" : "";
        InvokeIfNotDisposed(StateHasChanged);
    }

    private void OnInput(ChangeEventArgs e) => _manualInput = e.Value?.ToString() ?? "";

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter" || string.IsNullOrEmpty(_manualInput))
        {
            return;
        }
        await BarcodeScanService.ProcessBarcodeAsync(_manualInput);
        _manualInput = "";
    }

    private void OnValidationChanged(string? error)
    {
        InvokeIfNotDisposed(() => ApplyValidationError(error));
    }

    private void ApplyValidationError(string? error)
    {
        if (!string.IsNullOrEmpty(error))
        {
            ShowErrorNotification(error);
        }
    }

    private void OnBoilerStateChanged()
    {
        InvokeIfNotDisposed(ClearManualInput);
    }

    private void ClearManualInput()
    {
        _manualInput = "";
        StateHasChanged();
    }

    private void InvokeIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        InvokeAsync(() => ExecuteIfNotDisposed(action));
    }

    private void ExecuteIfNotDisposed(Action action)
    {
        if (_disposed)
        {
            return;
        }
        action();
    }

    private void ShowErrorNotification(string error)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Error,
            Summary = "Ошибка при сканировании",
            Detail = error,
            Duration = 10000
        });
    }

    public void Dispose()
    {
        _disposed = true;
        ValidationState.OnErrorChanged -= OnValidationChanged;
        BoilerState.OnChanged -= OnBoilerStateChanged;
        TestSequenseService.OnDataChanged -= OnStepChanged;
    }
}
