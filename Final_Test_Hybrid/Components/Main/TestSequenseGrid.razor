@using Final_Test_Hybrid.Models.Steps
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution
@using Microsoft.JSInterop
@implements IDisposable
@inject TestSequenseService TestSequenseService
@inject IJSRuntime Js

<div class="test-sequense-grid" id="test-sequense-grid-container">
    <RadzenDataGrid @ref="_grid"
        TItem="TestSequenseData"
        Data="_data"
        class="main-grid-legacy"
        ColumnWidth="150px"
        AllowPaging="false"
        AllowSorting="false"
        >
        <Columns>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Module" Title="Модуль">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Module">@data.Module</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Description" Title="Описание">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Description">@data.Description</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Status" Title="Статус" Width="50px">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Status">@data.Status</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Result" Title="Результаты">
                <Template Context="data">
                    @{
                        var displayText = data.StepStatus == TestStepStatus.Running
                            ? data.ProgressMessage
                            : data.Result;
                    }
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@displayText">@displayText</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Range" Title="Пределы">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Range">@(string.IsNullOrEmpty(data.Range) ? "\u00A0" : data.Range)</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private RadzenDataGrid<TestSequenseData>? _grid;
    private IEnumerable<TestSequenseData> _data = [];
    private bool _pendingScrollToBottom = true;

    private static string GetCellClass(TestSequenseData data)
    {
        return data.StepStatus switch
        {
            TestStepStatus.Error => "error",
            TestStepStatus.Success => "success",
            TestStepStatus.Running => "running",
            _ => ""
        };
    }

    protected override void OnInitialized()
    {
        _data = TestSequenseService.Data;
        TestSequenseService.OnDataChanged += HandleDataChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_pendingScrollToBottom)
        {
            return;
        }

        _pendingScrollToBottom = false;
        await ScrollToBottom();
    }

    private async void HandleDataChanged()
    {
        try
        {
            await InvokeAsync(async () =>
            {
                _data = TestSequenseService.Data;
                _pendingScrollToBottom = true;
                StateHasChanged();
                if (_grid != null)
                {
                    await _grid.Reload();
                }
            });
        }
        catch (Exception)
        {
            // ignored
        }
    }

    private async Task ScrollToBottom()
    {
        await Js.InvokeVoidAsync("scrollGridToBottom", "test-sequense-grid-container");
    }

    public void Dispose()
    {
        TestSequenseService.OnDataChanged -= HandleDataChanged;
    }
}
