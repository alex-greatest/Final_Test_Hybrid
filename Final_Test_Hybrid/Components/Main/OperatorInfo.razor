@using Final_Test_Hybrid.Components.Main.Modals
@using Final_Test_Hybrid.Services.Common.Settings
@using Final_Test_Hybrid.Services.Main
@using Final_Test_Hybrid.Services.Main.PlcReset
@using Final_Test_Hybrid.Services.SpringBoot.Operator
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.ErrorCoordinator
@inject PlcResetCoordinator PlcResetCoordinator
@inject ErrorCoordinator ErrorCoordinator
@implements IDisposable

<div class="buttons-row">
    <RadzenButton Text="Авторизация оператора"
                  Icon="person"
                  ButtonStyle="ButtonStyle.Primary"
                  Style="background-color: #1e5fcf"
                  Click="@OpenLoginDialog"
                  Disabled="@(!CanShowAuthButton)"/>
    <RadzenButton Text="Выйти"
                  Icon="logout"
                  ButtonStyle="ButtonStyle.Light"
                  Style="color: black"
                  Click="@OnLogout"
                  Disabled="@(!CanShowLogoutButton)"/>
</div>
<div class="field-row field-row-operator">
    <RadzenLabel Text="Имя оператора"/>
    <RadzenTextBox Style="width:100%" Value="@OperatorState.Username" ReadOnly="true"/>
</div>

@code {
    [Inject]
    public required DialogService DialogService { get; set; }
    [Inject]
    public required NotificationService NotificationService { get; set; }
    [Inject]
    public required OperatorState OperatorState { get; set; }
    [Inject]
    public required OperatorAuthService OperatorAuthService { get; set; }
    [Inject]
    public required AppSettingsService AppSettingsService { get; set; }
    [Inject]
    public required TestSequenseService TestSequenseService { get; set; }
    [Inject]
    public required AutoReadySubscription AutoReadySubscription { get; set; }

    private bool IsOnScanStep => TestSequenseService.IsOnActiveScanStep;
    private bool IsWaitingForAuto => !TestSequenseService.Data.Any() && !AutoReadySubscription.IsReady;
    private bool IsBlocked => PlcResetCoordinator.IsActive || ErrorCoordinator.CurrentInterrupt != null;
    private bool CanInteract => !IsBlocked && (IsOnScanStep || IsWaitingForAuto || !TestSequenseService.Data.Any());
    private bool CanShowAuthButton => !OperatorState.IsAuthenticated && CanInteract;
    private bool CanShowLogoutButton => OperatorState.IsAuthenticated && CanInteract;
    private bool _disposed;

    protected override void OnInitialized()
    {
        OperatorState.OnStateChanged += OnLocalStateChanged;
        TestSequenseService.OnDataChanged += OnLocalStateChanged;
        AutoReadySubscription.OnStateChanged += OnLocalStateChanged;
        PlcResetCoordinator.OnActiveChanged += OnLocalStateChanged;
        ErrorCoordinator.OnInterruptChanged += OnLocalStateChanged;
    }

    private void OnLocalStateChanged()
    {
        if (_disposed) return;
        _ = InvokeAsync(StateHasChanged);
    }

    private Task OpenLoginDialog() => (AppSettingsService.UseMes, AppSettingsService.UseOperatorQrAuth) switch
    {
        (false, _) => OpenManualLoginDialog(),
        (true, true) => OpenUserScanDialog(),
        _ => OpenMesLoginDialog()
    };

    private async Task OpenUserScanDialog()
    {
        await DialogService.OpenAsync<UserScanDialog>("Авторизация оператора",
            new Dictionary<string, object> { { "Text", "Отсканируйте код оператора" } },
            options: new DialogOptions
            {
                Width = "450px",
                CloseDialogOnOverlayClick = false,
                ShowClose = true,
                CssClass = "operator-login-dialog"
            });
    }

    private async Task OpenMesLoginDialog()
    {
        await DialogService.OpenAsync<OperatorLoginDialog>("Авторизация оператора",
            options: new DialogOptions
            {
                Width = "450px",
                CloseDialogOnOverlayClick = false,
                ShowClose = true,
                CssClass = "operator-login-dialog"
            });
    }

    private async Task OpenManualLoginDialog()
    {
        await DialogService.OpenAsync<OperatorManualLoginDialog>("Авторизация оператора",
            options: new DialogOptions
            {
                Width = "450px",
                CloseDialogOnOverlayClick = false,
                ShowClose = true,
                CssClass = "operator-login-dialog"
            });
    }

    private async Task OnLogout()
    {
        if (AppSettingsService.UseMes)
        {
            await LogoutMes();
            return;
        }
        LogoutManual();
    }

    private async Task LogoutMes()
    {
        var result = await OperatorAuthService.LogoutAsync();
        if (result.Success)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Выход выполнен");
            return;
        }
        NotificationService.Notify(NotificationSeverity.Error, result.ErrorMessage ?? "Неизвестная ошибка");
    }

    private void LogoutManual()
    {
        OperatorAuthService.ManualLogout();
        NotificationService.Notify(NotificationSeverity.Success, "Выход выполнен");
    }

    public void Dispose()
    {
        _disposed = true;
        OperatorState.OnStateChanged -= OnLocalStateChanged;
        TestSequenseService.OnDataChanged -= OnLocalStateChanged;
        AutoReadySubscription.OnStateChanged -= OnLocalStateChanged;
        PlcResetCoordinator.OnActiveChanged -= OnLocalStateChanged;
        ErrorCoordinator.OnInterruptChanged -= OnLocalStateChanged;
    }
}
