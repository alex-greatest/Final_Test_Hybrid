@using Final_Test_Hybrid.Models.Database
@using Final_Test_Hybrid.Services.Database.Config
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging

@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject ILogger<ArchiveGrid> Logger
@inject NotificationService NotificationService

<div class="tab-content">
    <div class="grid-toolbar">
        <div class="filter-section">
            <RadzenLabel Text="От:" />
            <RadzenDatePicker @bind-Value="_dateFrom" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm" />
            <RadzenLabel Text="До:" />
            <RadzenDatePicker @bind-Value="_dateTo" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm" />
            <RadzenButton Icon="search" Text="Загрузить" Click="@LoadDataAsync" />
        </div>
        <div class="toolbar-buttons">
            <RadzenButton Icon="refresh" Text="Обновить" Click="@LoadDataAsync" />
        </div>
        <span class="record-count">Записей: @_operations.Count</span>
    </div>

    <RadzenDataGrid Data="@_operations" TItem="Operation"
                    AllowFiltering="true" AllowSorting="true"
                    AllowColumnReorder="true"
                    FilterText="@DataGridRu.Filter"
                    ApplyFilterText="@DataGridRu.ApplyFilter"
                    ClearFilterText="@DataGridRu.ClearFilter"
                    EqualsText="@DataGridRu.Equals"
                    NotEqualsText="@DataGridRu.NotEquals"
                    ContainsText="@DataGridRu.Contains"
                    DoesNotContainText="@DataGridRu.DoesNotContain"
                    StartsWithText="@DataGridRu.StartsWith"
                    EndsWithText="@DataGridRu.EndsWith"
                    GreaterThanText="@DataGridRu.GreaterThan"
                    GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                    LessThanText="@DataGridRu.LessThan"
                    LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                    IsNullText="@DataGridRu.IsNull"
                    IsNotNullText="@DataGridRu.IsNotNull"
                    IsEmptyText="@DataGridRu.IsEmpty"
                    IsNotEmptyText="@DataGridRu.IsNotEmpty"
                    AndOperatorText="@DataGridRu.And"
                    OrOperatorText="@DataGridRu.Or"
                    EmptyText="@DataGridRu.Empty">
        <Columns>
            <RadzenDataGridColumn TItem="Operation" Property="Boiler.SerialNumber"
                                  Title="Серийный номер">
                <Template Context="item">
                    @(item.Boiler?.SerialNumber ?? "-")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="Status" Title="Статус" Width="120px">
                <Template Context="item">
                    <RadzenBadge BadgeStyle="@GetStatusBadgeStyle(item.Status)"
                                 Text="@GetStatusText(item.Status)" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="DateStart" Title="Начало">
                <Template Context="item">
                    @item.DateStart.ToString("dd.MM.yyyy HH:mm:ss")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="DateEnd" Title="Окончание">
                <Template Context="item">
                    @(item.DateEnd?.ToString("dd.MM.yyyy HH:mm:ss") ?? "-")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="Operator" Title="Оператор" />

            <RadzenDataGridColumn TItem="Operation" Property="NumberShift" Title="Смена" Width="80px" />

            <RadzenDataGridColumn TItem="Operation" Property="Comment" Title="Комментарий" />
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private DateTime? _dateFrom = DateTime.UtcNow.AddDays(-7);
    private DateTime? _dateTo = DateTime.UtcNow.AddDays(1);
    private List<Operation> _operations = [];

    /// <summary>
    /// Загружает операции из базы данных с учетом фильтров по дате.
    /// Операции со статусом InWork (DateEnd == null) всегда включаются в выборку.
    /// </summary>
    private async Task LoadDataAsync()
    {
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            var query = db.Operations
                .Include(o => o.Boiler)
                .AsQueryable();

            if (_dateFrom.HasValue)
            {
                var fromUtc = _dateFrom.Value.Kind == DateTimeKind.Utc
                    ? _dateFrom.Value
                    : _dateFrom.Value.ToUniversalTime();
                query = query.Where(o => o.DateEnd == null || o.DateEnd >= fromUtc);
            }

            if (_dateTo.HasValue)
            {
                var toUtc = _dateTo.Value.Kind == DateTimeKind.Utc
                    ? _dateTo.Value
                    : _dateTo.Value.ToUniversalTime();
                query = query.Where(o => o.DateEnd == null || o.DateEnd <= toUtc);
            }

            _operations = await query
                .OrderByDescending(o => o.DateEnd)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load operations");
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", "Ошибка базы данных");
        }
    }

    /// <summary>
    /// Возвращает стиль бейджа для статуса операции.
    /// </summary>
    private static BadgeStyle GetStatusBadgeStyle(OperationResultStatus status) => status switch
    {
        OperationResultStatus.Ok => BadgeStyle.Success,
        OperationResultStatus.Nok => BadgeStyle.Danger,
        OperationResultStatus.InWork => BadgeStyle.Info,
        OperationResultStatus.Interrupted => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    /// <summary>
    /// Возвращает текст для статуса операции.
    /// </summary>
    private static string GetStatusText(OperationResultStatus status) => status switch
    {
        OperationResultStatus.Ok => "OK",
        OperationResultStatus.Nok => "NOK",
        OperationResultStatus.InWork => "В работе",
        OperationResultStatus.Interrupted => "Прерван",
        _ => "?"
    };
}
