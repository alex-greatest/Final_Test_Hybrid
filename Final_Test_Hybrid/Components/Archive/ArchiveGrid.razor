@using System.IO
@using Final_Test_Hybrid.Models.Archive
@using Final_Test_Hybrid.Models.Database
@using Final_Test_Hybrid.Services.Archive
@using Final_Test_Hybrid.Services.Database.Config
@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Logging

@inject IDbContextFactory<AppDbContext> DbContextFactory
@inject ILogger<ArchiveGrid> Logger
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ArchiveExcelExportService ExcelExportService
@inject OperationDetailsService OperationDetailsService

<div class="tab-content">
    <div class="grid-toolbar">
        <div class="filter-section">
            <RadzenLabel Text="От:"/>
            <RadzenDatePicker @bind-Value="_dateFrom" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm"/>
            <RadzenLabel Text="До:"/>
            <RadzenDatePicker @bind-Value="_dateTo" ShowTime="true" DateFormat="dd.MM.yyyy HH:mm"/>
            <RadzenButton Icon="search" Text="Найти" Click="@LoadDataAsync"/>
            <RadzenButton Icon="refresh" Text="Обновить" Click="@LoadDataAsync" />
        </div>
        <span class="record-count">Записей: @_operations.Count</span>
    </div>

    <RadzenDataGrid Data="@_operations" TItem="Operation"
                    AllowFiltering="true" AllowSorting="true"
                    AllowColumnReorder="true"
                    AllowPaging="true"
                    PageSize="50"
                    PagerHorizontalAlign="HorizontalAlign.Center"
                    ShowPagingSummary="true"
                    PagingSummaryFormat="Показано {0}-{1} из {2}"
                    FilterText="@DataGridRu.Filter"
                    ApplyFilterText="@DataGridRu.ApplyFilter"
                    ClearFilterText="@DataGridRu.ClearFilter"
                    EqualsText="@DataGridRu.Equals"
                    NotEqualsText="@DataGridRu.NotEquals"
                    ContainsText="@DataGridRu.Contains"
                    DoesNotContainText="@DataGridRu.DoesNotContain"
                    StartsWithText="@DataGridRu.StartsWith"
                    EndsWithText="@DataGridRu.EndsWith"
                    GreaterThanText="@DataGridRu.GreaterThan"
                    GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                    LessThanText="@DataGridRu.LessThan"
                    LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                    IsNullText="@DataGridRu.IsNull"
                    IsNotNullText="@DataGridRu.IsNotNull"
                    IsEmptyText="@DataGridRu.IsEmpty"
                    IsNotEmptyText="@DataGridRu.IsNotEmpty"
                    AndOperatorText="@DataGridRu.And"
                    OrOperatorText="@DataGridRu.Or"
                    EmptyText="@DataGridRu.Empty">
        <Columns>
            <RadzenDataGridColumn TItem="Operation" Property="Boiler.SerialNumber"
                                  Title="Серийный номер">
                <Template Context="item">
                    @(item.Boiler?.SerialNumber ?? "-")
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="Status" Title="Статус" Width="120px">
                <Template Context="item">
                    <RadzenBadge Style="padding: 5px" BadgeStyle="@GetStatusBadgeStyle(item.Status)"
                                 Text="@GetStatusText(item.Status)" />
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="DateStart" Title="Начало">
                <Template Context="item">
                    @FormatUtcToLocal(item.DateStart)
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="DateEnd" Title="Окончание">
                <Template Context="item">
                    @FormatUtcToLocal(item.DateEnd)
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Operation" Property="Operator" Title="Оператор" />

            <RadzenDataGridColumn TItem="Operation" Property="NumberShift" Title="Смена" Width="80px" />

            <RadzenDataGridColumn TItem="Operation" Property="Comment" Title="Комментарий" />

            <RadzenDataGridColumn TItem="Operation" Width="120px" Sortable="false" Filterable="false">
                <Template Context="item">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="4">
                        @if (item.Status == OperationResultStatus.Ok || item.Status == OperationResultStatus.Nok)
                        {
                            <RadzenButton Icon="visibility" Size="ButtonSize.Medium"
                                          ButtonStyle="@GetStatusButtonStyle(item.Status)"
                                          Click="@(() => ShowDetailsAsync(item))" />
                            <RadzenButton Icon="file_download" Size="ButtonSize.Medium"
                                          ButtonStyle="ButtonStyle.Success"
                                          Disabled="@_isExporting"
                                          Click="@(() => ExportToExcelAsync(item))" />
                        }
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private DateTime? _dateFrom = DateTime.Now.AddDays(-7);
    private DateTime? _dateTo = DateTime.Now.AddDays(1);
    private List<Operation> _operations = [];
    private bool _isExporting;

    /// <summary>
    /// Конвертирует UTC DateTime (с Kind=Unspecified от Npgsql) в строку локального времени.
    /// </summary>
    private static string FormatUtcToLocal(DateTime utcDateTime) =>
        DateTime.SpecifyKind(utcDateTime, DateTimeKind.Utc)
                .ToLocalTime()
                .ToString("dd.MM.yyyy HH:mm:ss");

    /// <summary>
    /// Конвертирует nullable UTC DateTime в строку локального времени или прочерк если null.
    /// </summary>
    private static string FormatUtcToLocal(DateTime? utcDateTime) =>
        utcDateTime.HasValue ? FormatUtcToLocal(utcDateTime.Value) : "-";

    /// <summary>
    /// Загружает операции из базы данных с учетом фильтров по дате.
    /// Операции со статусом InWork (DateEnd == null) фильтруются по DateStart.
    /// </summary>
    private async Task LoadDataAsync()
    {
        try
        {
            await using var db = await DbContextFactory.CreateDbContextAsync();
            var query = db.Operations
                .Include(o => o.Boiler)
                .AsQueryable();

            if (_dateFrom.HasValue)
            {
                var fromUtc = _dateFrom.Value.Kind == DateTimeKind.Utc
                    ? _dateFrom.Value
                    : _dateFrom.Value.ToUniversalTime();
                query = query.Where(o => o.DateEnd != null ? o.DateEnd >= fromUtc : o.DateStart >= fromUtc);
            }

            if (_dateTo.HasValue)
            {
                var toUtc = _dateTo.Value.Kind == DateTimeKind.Utc
                    ? _dateTo.Value
                    : _dateTo.Value.ToUniversalTime();
                query = query.Where(o => o.DateEnd != null ? o.DateEnd <= toUtc : o.DateStart <= toUtc);
            }

            _operations = await query
                .OrderByDescending(o => o.DateStart)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load operations");
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", "Ошибка базы данных");
        }
    }

    /// <summary>
    /// Возвращает стиль кнопки для статуса операции.
    /// </summary>
    private static ButtonStyle GetStatusButtonStyle(OperationResultStatus status) => status switch
    {
        OperationResultStatus.Ok => ButtonStyle.Success,
        OperationResultStatus.Nok => ButtonStyle.Danger,
        OperationResultStatus.InWork => ButtonStyle.Info,
        OperationResultStatus.Interrupted => ButtonStyle.Warning,
        _ => ButtonStyle.Light
    };

    /// <summary>
    /// Возвращает стиль бейджа для статуса операции.
    /// </summary>
    private static BadgeStyle GetStatusBadgeStyle(OperationResultStatus status) => status switch
    {
        OperationResultStatus.Ok => BadgeStyle.Success,
        OperationResultStatus.Nok => BadgeStyle.Danger,
        OperationResultStatus.InWork => BadgeStyle.Info,
        OperationResultStatus.Interrupted => BadgeStyle.Warning,
        _ => BadgeStyle.Light
    };

    /// <summary>
    /// Возвращает текст для статуса операции.
    /// </summary>
    private static string GetStatusText(OperationResultStatus status) => status switch
    {
        OperationResultStatus.Ok => "OK",
        OperationResultStatus.Nok => "NOK",
        OperationResultStatus.InWork => "В работе",
        OperationResultStatus.Interrupted => "Прерван",
        _ => "?"
    };

    /// <summary>
    /// Открывает диалог с деталями операции.
    /// </summary>
    private async Task ShowDetailsAsync(Operation operation)
    {
        var serialNumber = operation.Boiler?.SerialNumber ?? "-";
        var title = $"Операция #{operation.Id} - {serialNumber}";

        await DialogService.OpenAsync<OperationDetailsDialog>(
            title,
            new Dictionary<string, object> { { "Operation", operation } },
            new DialogOptions
            {
                Width = "95vw",
                Height = "95vh",
                Resizable = true,
                Draggable = true,
                CssClass = "stand-database-dialog",
                CloseDialogOnOverlayClick = false
            });
    }

    /// <summary>
    /// Экспортирует данные операции в Excel.
    /// </summary>
    private async Task ExportToExcelAsync(Operation operation)
    {
        if (_isExporting)
        {
            return;
        }

        _isExporting = true;
        StateHasChanged();

        try
        {
            var numericWithRange = await OperationDetailsService.GetResultsAsync(
                operation.Id, AuditType.NumericWithRange);
            var simpleStatus = await OperationDetailsService.GetResultsAsync(
                operation.Id, AuditType.SimpleStatus);
            var boardParameters = await OperationDetailsService.GetResultsAsync(
                operation.Id, AuditType.BoardParameters);
            var errors = await OperationDetailsService.GetErrorsAsync(operation.Id);
            var stepTimes = await OperationDetailsService.GetStepTimesAsync(operation.Id);

            var data = new ArchiveExportData
            {
                DateStart = operation.DateStart,
                SerialNumber = operation.Boiler?.SerialNumber ?? "-",
                NumericWithRange = numericWithRange,
                SimpleStatus = simpleStatus,
                BoardParameters = boardParameters,
                Errors = errors,
                StepTimes = stepTimes
            };

            var serialNumber = SanitizeFileName(operation.Boiler?.SerialNumber ?? "Unknown");
            var fileName = $"{serialNumber}_{operation.DateStart:dd.MM.yyyy_HH-mm-ss}.xlsx";

            await Task.Run(() => ExcelExportService.Export(data, fileName));
            NotificationService.Notify(NotificationSeverity.Success, "Готово", "Файл сохранён");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка экспорта операции {OperationId}", operation.Id);
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", "Не удалось создать файл");
        }
        finally
        {
            _isExporting = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Очищает строку от недопустимых символов для имени файла.
    /// </summary>
    private static string SanitizeFileName(string input)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = string.Concat(input.Where(c => !invalidChars.Contains(c)));
        return sanitized.Length > 50 ? sanitized[..50] :
               string.IsNullOrWhiteSpace(sanitized) ? "Export" : sanitized;
    }
}
