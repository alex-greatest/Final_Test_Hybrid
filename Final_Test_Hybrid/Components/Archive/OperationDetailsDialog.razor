@using System.IO
@using Final_Test_Hybrid.Models.Archive
@using Final_Test_Hybrid.Models.Database
@using Final_Test_Hybrid.Services.Archive
@using Microsoft.Extensions.Logging

@inject OperationDetailsService OperationDetailsService
@inject ArchiveExcelExportService ExcelExportService
@inject NotificationService NotificationService
@inject ILogger<OperationDetailsDialog> Logger

<div class="stand-database-container">
    <div class="dialog-toolbar">
        <RadzenButton Icon="file_download" Text="Сохранить в Excel"
                      Click="@ExportToExcelAsync"
                      ButtonStyle="ButtonStyle.Success"
                      Size="ButtonSize.Medium"
                      Disabled="@(!CanExport)" />
    </div>
    <div class="tabs-shell">
        <RadzenTabs RenderMode="TabRenderMode.Client" @bind-SelectedIndex="_selectedTabIndex" class="database-tabs">
            <Tabs>
                <RadzenTabsItem Text="С диапазоном">
                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </div>
                    }
                    else
                    {
                        <ArchiveResultsGrid Data="_numericWithRangeResults" ShowRange="true" />
                    }
                </RadzenTabsItem>

                <RadzenTabsItem Text="Без диапазона">
                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </div>
                    }
                    else
                    {
                        <ArchiveResultsGrid Data="_simpleStatusResults" ShowRange="false" />
                    }
                </RadzenTabsItem>

                <RadzenTabsItem Text="Плата">
                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </div>
                    }
                    else
                    {
                        <ArchiveResultsGrid Data="_boardParametersResults" ShowRange="true" />
                    }
                </RadzenTabsItem>

                <RadzenTabsItem Text="Ошибки">
                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </div>
                    }
                    else
                    {
                        <ArchiveErrorsGrid Data="_errors" />
                    }
                </RadzenTabsItem>

                <RadzenTabsItem Text="Время шагов">
                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        </div>
                    }
                    else
                    {
                        <ArchiveStepTimesGrid Data="_stepTimes" />
                    }
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </div>
</div>

@code {
    [Parameter]
    public Operation Operation { get; set; } = null!;

    private int _selectedTabIndex;
    private bool _isExporting;
    private bool _isLoading = true;

    private IReadOnlyList<ArchiveResultItem> _numericWithRangeResults = [];
    private IReadOnlyList<ArchiveResultItem> _simpleStatusResults = [];
    private IReadOnlyList<ArchiveResultItem> _boardParametersResults = [];
    private IReadOnlyList<ArchiveErrorItem> _errors = [];
    private IReadOnlyList<ArchiveStepTimeItem> _stepTimes = [];

    /// <summary>
    /// Экспорт доступен только для завершённых операций (OK/NOK).
    /// </summary>
    private bool CanExport => !_isExporting &&
        (Operation.Status == OperationResultStatus.Ok || Operation.Status == OperationResultStatus.Nok);

    /// <summary>
    /// Загружает все данные при инициализации.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        await LoadAllDataAsync();
    }

    /// <summary>
    /// Загружает все данные параллельно.
    /// </summary>
    private async Task LoadAllDataAsync()
    {
        _isLoading = true;

        var numericTask = OperationDetailsService.GetResultsAsync(Operation.Id, AuditType.NumericWithRange);
        var simpleTask = OperationDetailsService.GetResultsAsync(Operation.Id, AuditType.SimpleStatus);
        var boardTask = OperationDetailsService.GetResultsAsync(Operation.Id, AuditType.BoardParameters);
        var errorsTask = OperationDetailsService.GetErrorsAsync(Operation.Id);
        var stepTimesTask = OperationDetailsService.GetStepTimesAsync(Operation.Id);

        await Task.WhenAll(numericTask, simpleTask, boardTask, errorsTask, stepTimesTask);

        _numericWithRangeResults = await numericTask;
        _simpleStatusResults = await simpleTask;
        _boardParametersResults = await boardTask;
        _errors = await errorsTask;
        _stepTimes = await stepTimesTask;

        _isLoading = false;
    }

    /// <summary>
    /// Экспортирует данные операции в Excel файл.
    /// </summary>
    private async Task ExportToExcelAsync()
    {
        if (_isExporting || !CanExport)
        {
            return;
        }

        _isExporting = true;
        StateHasChanged();

        try
        {
            var exportedAt = DateTime.Now;
            var data = new ArchiveExportData
            {
                DateStart = Operation.DateStart,
                DateEnd = Operation.DateEnd,
                ExportedAt = exportedAt,
                SerialNumber = Operation.Boiler?.SerialNumber ?? "-",
                NumericWithRange = _numericWithRangeResults,
                SimpleStatus = _simpleStatusResults,
                BoardParameters = _boardParametersResults,
                Errors = _errors,
                StepTimes = _stepTimes
            };

            var serialNumber = SanitizeFileName(Operation.Boiler?.SerialNumber ?? "Unknown");
            var fileName = $"{serialNumber}_Выгрузка от {exportedAt:dd.MM.yyyy HH-mm-ss}.xlsx";
            await Task.Run(() => ExcelExportService.Export(data, fileName));
            NotificationService.Notify(NotificationSeverity.Success, "Готово", $"Файл сохранён");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Ошибка экспорта архива в Excel для операции {OperationId}", Operation.Id);
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка", "Ошибка при создании отчёта");
        }
        finally
        {
            _isExporting = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Очищает строку от недопустимых символов для имени файла.
    /// </summary>
    private static string SanitizeFileName(string input)
    {
        var invalidChars = Path.GetInvalidFileNameChars();
        var sanitized = string.Concat(input.Where(c => !invalidChars.Contains(c)));

        if (sanitized.Length > 50)
        {
            sanitized = sanitized[..50];
        }

        return string.IsNullOrWhiteSpace(sanitized) ? "Export" : sanitized;
    }
}
