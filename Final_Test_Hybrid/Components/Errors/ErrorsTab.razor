@using Final_Test_Hybrid.Localization
@using Final_Test_Hybrid.Models.Errors
@using Final_Test_Hybrid.Services.Errors

@inject IActiveErrorsService ActiveErrorsService
@inject IErrorHistoryService ErrorHistoryService

@implements IDisposable

<div class="tab-content">
    @if (_isLoading)
    {
        <div class="loading-container">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </div>
    }
    else
    {
        <RadzenDataGrid Data="@_activeErrors" TItem="ActiveError"
                        AllowFiltering="true" AllowSorting="true"
                        FilterText="@DataGridRu.Filter"
                        ApplyFilterText="@DataGridRu.ApplyFilter"
                        ClearFilterText="@DataGridRu.ClearFilter"
                        EqualsText="@DataGridRu.Equals"
                        NotEqualsText="@DataGridRu.NotEquals"
                        ContainsText="@DataGridRu.Contains"
                        DoesNotContainText="@DataGridRu.DoesNotContain"
                        StartsWithText="@DataGridRu.StartsWith"
                        EndsWithText="@DataGridRu.EndsWith"
                        GreaterThanText="@DataGridRu.GreaterThan"
                        GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                        LessThanText="@DataGridRu.LessThan"
                        LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                        IsNullText="@DataGridRu.IsNull"
                        IsNotNullText="@DataGridRu.IsNotNull"
                        IsEmptyText="@DataGridRu.IsEmpty"
                        IsNotEmptyText="@DataGridRu.IsNotEmpty"
                        AndOperatorText="@DataGridRu.And"
                        OrOperatorText="@DataGridRu.Or"
                        EmptyText=" ">
            <Columns>
                <RadzenDataGridColumn TItem="ActiveError" Property="Time" Title="Время" Width="180px">
                    <Template Context="item">
                        @item.Time.ToString("dd.MM.yyyy HH:mm:ss")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="ActiveError" Property="Code" Title="Код" Width="120px" />
                <RadzenDataGridColumn TItem="ActiveError" Property="Description" Title="Описание" />
                <RadzenDataGridColumn TItem="ActiveError" Property="TestName" Title="Название теста" Width="250px" />
            </Columns>
        </RadzenDataGrid>
    }
</div>

@code {
    private bool _isLoading = true;
    private IReadOnlyList<ActiveError> _activeErrors = [];
    private IReadOnlyList<ErrorHistoryItem> _errorHistory = [];

    protected override void OnInitialized()
    {
        ActiveErrorsService.OnChanged += OnActiveErrorsChanged;
        ErrorHistoryService.OnChanged += OnErrorHistoryChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(50);
            RefreshData();
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnActiveErrorsChanged()
    {
        _ = InvokeAsync(() =>
        {
            _activeErrors = ActiveErrorsService.GetErrors();
            StateHasChanged();
        });
    }

    private void OnErrorHistoryChanged()
    {
        _ = InvokeAsync(() =>
        {
            _errorHistory = ErrorHistoryService.GetHistory();
            StateHasChanged();
        });
    }

    private void RefreshData()
    {
        _activeErrors = ActiveErrorsService.GetErrors();
        _errorHistory = ErrorHistoryService.GetHistory();
    }

    public void Dispose()
    {
        ActiveErrorsService.OnChanged -= OnActiveErrorsChanged;
        ErrorHistoryService.OnChanged -= OnErrorHistoryChanged;
    }
}
