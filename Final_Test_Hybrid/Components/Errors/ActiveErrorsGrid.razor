@using Final_Test_Hybrid.Models.Errors
@using Final_Test_Hybrid.Services.Errors

@inject IErrorService ErrorService

@implements IAsyncDisposable

<div class="errors-grid-wrapper grid-unified-host">
    <RadzenDataGrid Data="@_activeErrors" TItem="ActiveErrorGridRow" class="grid-unified"
                AllowFiltering="true" AllowSorting="true"
                FilterText="@DataGridRu.Filter"
                ApplyFilterText="@DataGridRu.ApplyFilter"
                ClearFilterText="@DataGridRu.ClearFilter"
                EqualsText="@DataGridRu.Equals"
                NotEqualsText="@DataGridRu.NotEquals"
                ContainsText="@DataGridRu.Contains"
                DoesNotContainText="@DataGridRu.DoesNotContain"
                StartsWithText="@DataGridRu.StartsWith"
                EndsWithText="@DataGridRu.EndsWith"
                GreaterThanText="@DataGridRu.GreaterThan"
                GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                LessThanText="@DataGridRu.LessThan"
                LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                IsNullText="@DataGridRu.IsNull"
                IsNotNullText="@DataGridRu.IsNotNull"
                IsEmptyText="@DataGridRu.IsEmpty"
                IsNotEmptyText="@DataGridRu.IsNotEmpty"
                AndOperatorText="@DataGridRu.And"
                OrOperatorText="@DataGridRu.Or"
                EmptyText="Нет данных">
    <Columns>
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="Code" Title="Код" Width="80px" />
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="Severity" Title="Тип" Width="120px">
            <Template Context="item">
                @switch (item.Severity)
                {
                    case ErrorSeverity.Critical:
                        <span style="color: red; font-weight: bold;">Критическая</span>
                        break;
                    case ErrorSeverity.Warning:
                        <span style="color: orange;">Предупреждение</span>
                        break;
                    case ErrorSeverity.Info:
                        <span style="color: gray;">Инфо</span>
                        break;
                }
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="Time" Title="Время" Width="100px">
            <Template Context="item">
                @item.Time.ToString("HH:mm:ss")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="StepName" Title="Шаг" Width="200px">
            <Template Context="item">
                @(item.StepName ?? "-")
            </Template>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="Description" Title="Описание"/>
        <RadzenDataGridColumn TItem="ActiveErrorGridRow" Property="SourceLabel" Title="Источник" Width="100px">
            <Template Context="item">
                @item.SourceLabel
            </Template>
        </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private bool _disposed;
    private IReadOnlyList<ActiveErrorGridRow> _activeErrors = [];

    private sealed record ActiveErrorGridRow(ActiveError Error, string SourceLabel)
    {
        public string Code => Error.Code;
        public ErrorSeverity Severity => Error.Severity;
        public DateTime Time => Error.Time;
        public string? StepName => Error.StepName;
        public string Description => Error.Description;
    }

    private static string GetSourceLabel(ActiveError item)
    {
        if (item.Source == ErrorSource.Plc
            || item.Code == ErrorDefinitions.OpcConnectionLost.Code
            || item.Code == ErrorDefinitions.TagReadTimeout.Code)
        {
            return "PLC";
        }

        return "Котёл";
    }

    private static IReadOnlyList<ActiveErrorGridRow> BuildGridRows(IReadOnlyList<ActiveError> activeErrors)
    {
        return activeErrors
            .Select(error => new ActiveErrorGridRow(error, GetSourceLabel(error)))
            .ToList();
    }

    protected override void OnInitialized()
    {
        ErrorService.OnActiveErrorsChanged += OnErrorsChanged;
        _activeErrors = BuildGridRows(ErrorService.GetActiveErrors());
    }

    private void OnErrorsChanged()
    {
        _ = InvokeAsync(() =>
        {
            if (_disposed)
            {
                return;
            }
            _activeErrors = BuildGridRows(ErrorService.GetActiveErrors());
            StateHasChanged();
        });
    }

    public ValueTask DisposeAsync()
    {
        _disposed = true;
        ErrorService.OnActiveErrorsChanged -= OnErrorsChanged;
        return ValueTask.CompletedTask;
    }
}
