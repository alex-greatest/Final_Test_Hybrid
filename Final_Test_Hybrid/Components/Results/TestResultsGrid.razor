@using Final_Test_Hybrid.Models.Results
@using Final_Test_Hybrid.Services.Results
@inject BoilerState BoilerState

@inject ITestResultsService TestResultsService

@implements IDisposable

<div class="test-results-grid grid-unified-host">
    @if (_isLoading)
    {
        <div class="loading-container">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(BoilerState.LastSerialNumber))
        {
            <div class="last-test-header">
                @if (BoilerState.LastTestCompletedAt.HasValue)
                {
                    <div>Дата/время: @BoilerState.LastTestCompletedAt?.ToString("dd.MM.yyyy HH:mm:ss")</div>
                }
                <div>Серийный номер: @BoilerState.LastSerialNumber</div>
            </div>
        }
        <RadzenDataGrid Data="@_results" TItem="TestResultItem" class="grid-unified"
                        AllowFiltering="true" AllowSorting="true"
                        AllowPaging="true"
                        PageSize="50"
                        PagerHorizontalAlign="HorizontalAlign.Center"
                        ShowPagingSummary="true"
                        PagingSummaryFormat="Показано {0}-{1} из {2}"
                        FilterText="@DataGridRu.Filter"
                        ApplyFilterText="@DataGridRu.ApplyFilter"
                        ClearFilterText="@DataGridRu.ClearFilter"
                        EqualsText="@DataGridRu.Equals"
                        NotEqualsText="@DataGridRu.NotEquals"
                        ContainsText="@DataGridRu.Contains"
                        DoesNotContainText="@DataGridRu.DoesNotContain"
                        StartsWithText="@DataGridRu.StartsWith"
                        EndsWithText="@DataGridRu.EndsWith"
                        GreaterThanText="@DataGridRu.GreaterThan"
                        GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                        LessThanText="@DataGridRu.LessThan"
                        LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                        IsNullText="@DataGridRu.IsNull"
                        IsNotNullText="@DataGridRu.IsNotNull"
                        IsEmptyText="@DataGridRu.IsEmpty"
                        IsNotEmptyText="@DataGridRu.IsNotEmpty"
                        AndOperatorText="@DataGridRu.And"
                        OrOperatorText="@DataGridRu.Or"
                        EmptyText="Нет данных">
            <Columns>
                <RadzenDataGridColumn TItem="TestResultItem" Property="Time" Title="Время" Width="180px">
                    <Template Context="item">
                        @item.Time.ToString("dd.MM.yyyy HH:mm:ss")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="TestResultItem" Property="ParameterName" Title="Параметр" />
                <RadzenDataGridColumn TItem="TestResultItem" Property="Min" Title="Мин" Width="100px" />
                <RadzenDataGridColumn TItem="TestResultItem" Property="Value" Title="Значение" Width="150px" />
                <RadzenDataGridColumn TItem="TestResultItem" Property="Max" Title="Макс" Width="100px" />
                <RadzenDataGridColumn TItem="TestResultItem" Property="IsRanged" Title="Тип" Width="120px">
                    <Template Context="item">
                        @(item.IsRanged ? "с диапазоном" : "без диапазона")
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="TestResultItem" Property="Status" Title="Статус" Width="80px">
                    <Template Context="item">
                        @if (TryGetStatusView(item.Status, out var badgeStyle, out var statusText))
                        {
                            <RadzenBadge BadgeStyle="@badgeStyle"
                                         Text="@statusText"
                                         Style="padding: 10px;" />
                        }
                        else
                        {
                            <span>-</span>
                        }
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="TestResultItem" Property="Unit" Title="Ед. изм." Width="100px" />
            </Columns>
        </RadzenDataGrid>
    }
</div>

@code {
    private bool _isLoading = true;
    private bool _disposed;
    private IReadOnlyList<TestResultItem> _results = [];

    protected override void OnInitialized()
    {
        TestResultsService.OnChanged += OnResultsChanged;
        BoilerState.OnChanged += OnBoilerStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Task.Delay(50);
            _results = TestResultsService.GetResults();
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void OnResultsChanged()
    {
        _ = InvokeAsync(() =>
        {
            if (_disposed)
            {
                return;
            }
            _results = TestResultsService.GetResults();
            StateHasChanged();
        });
    }

    private void OnBoilerStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _disposed = true;
        TestResultsService.OnChanged -= OnResultsChanged;
        BoilerState.OnChanged -= OnBoilerStateChanged;
    }

    private static bool TryGetStatusView(int status, out BadgeStyle badgeStyle, out string statusText)
    {
        switch (status)
        {
            case 1:
                badgeStyle = BadgeStyle.Success;
                statusText = "OK";
                return true;
            case 2:
                badgeStyle = BadgeStyle.Danger;
                statusText = "NOK";
                return true;
            default:
                badgeStyle = BadgeStyle.Success;
                statusText = string.Empty;
                return false;
        }
    }
}
