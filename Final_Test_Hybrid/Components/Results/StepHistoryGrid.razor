@using Final_Test_Hybrid.Models.Steps
@using Final_Test_Hybrid.Services.Export
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution
@inject StepHistoryService StepHistoryService
@inject StepHistoryExcelExporter Exporter
@inject BoilerState BoilerState
@inject NotificationService NotificationService

@implements IAsyncDisposable

<div class="step-history-grid grid-unified-host">
    <div class="grid-header">
        @if (!string.IsNullOrEmpty(BoilerState.LastSerialNumber))
        {
            <div class="last-test-header">
                @if (BoilerState.LastTestCompletedAt.HasValue)
                {
                    <div>Дата/время: @BoilerState.LastTestCompletedAt?.ToString("dd.MM.yyyy HH:mm:ss")</div>
                }
                <div>Серийный номер: @BoilerState.LastSerialNumber</div>
            </div>
        }
        else
        {
            <div></div>
        }
        <div class="toolbar-buttons">
            <RadzenButton Icon="file_download" Text="Сохранить в Excel"
                          Click="@ExportToExcel"
                          Disabled="@(!_data.Any())" />
        </div>
    </div>

    <RadzenDataGrid TItem="TestSequenseData"
        Data="_data"
        class="grid-unified"
        ColumnWidth="150px"
        AllowPaging="false"
        AllowSorting="false"
        EmptyText="Нет данных">
        <Columns>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Module" Title="Модуль">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Module">@data.Module</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Description" Title="Описание">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Description">@data.Description</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Status" Title="Статус" Width="50px">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Status">@data.Status</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Result" Title="Результаты">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Result">@data.Result</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="TestSequenseData" Property="Range" Title="Пределы">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Range">@(string.IsNullOrEmpty(data.Range) ? "\u00A0" : data.Range)</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private bool _disposed;
    private IEnumerable<TestSequenseData> _data = [];

    private static string GetCellClass(TestSequenseData data)
    {
        return data.StepStatus switch
        {
            TestStepStatus.Error => "error",
            TestStepStatus.Success => "success",
            TestStepStatus.Running => "running",
            _ => ""
        };
    }

    protected override void OnInitialized()
    {
        _data = StepHistoryService.Snapshot;
        StepHistoryService.OnChanged += OnDataChanged;
        BoilerState.OnChanged += OnBoilerStateChanged;
    }

    private void OnDataChanged()
    {
        _ = InvokeAsync(() =>
        {
            if (_disposed) return;
            _data = StepHistoryService.Snapshot;
            StateHasChanged();
        });
    }

    private void OnBoilerStateChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    private void ExportToExcel()
    {
        var (success, error) = Exporter.Export(_data);
        if (!success)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Ошибка экспорта", error);
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Success, "Экспорт завершён");
        }
    }

    public ValueTask DisposeAsync()
    {
        _disposed = true;
        StepHistoryService.OnChanged -= OnDataChanged;
        BoilerState.OnChanged -= OnBoilerStateChanged;
        return ValueTask.CompletedTask;
    }
}
