@using Final_Test_Hybrid.Models.Steps
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Timing

@inject IStepTimingService StepTimingService

@implements IAsyncDisposable

<div class="step-timings-wrapper">
    <RadzenDataGrid Data="@_timings" TItem="StepTimingRecord"
                    KeyProperty="Id"
                    AllowFiltering="true" AllowSorting="true"
                    FilterText="@DataGridRu.Filter"
                    ApplyFilterText="@DataGridRu.ApplyFilter"
                    ClearFilterText="@DataGridRu.ClearFilter"
                    EqualsText="@DataGridRu.Equals"
                    NotEqualsText="@DataGridRu.NotEquals"
                    ContainsText="@DataGridRu.Contains"
                    DoesNotContainText="@DataGridRu.DoesNotContain"
                    StartsWithText="@DataGridRu.StartsWith"
                    EndsWithText="@DataGridRu.EndsWith"
                    GreaterThanText="@DataGridRu.GreaterThan"
                    GreaterThanOrEqualsText="@DataGridRu.GreaterThanOrEquals"
                    LessThanText="@DataGridRu.LessThan"
                    LessThanOrEqualsText="@DataGridRu.LessThanOrEquals"
                    IsNullText="@DataGridRu.IsNull"
                    IsNotNullText="@DataGridRu.IsNotNull"
                    IsEmptyText="@DataGridRu.IsEmpty"
                    IsNotEmptyText="@DataGridRu.IsNotEmpty"
                    AndOperatorText="@DataGridRu.And"
                    OrOperatorText="@DataGridRu.Or"
                    EmptyText="Нет данных">
        <Columns>
            <RadzenDataGridColumn TItem="StepTimingRecord" Property="Name" Title="Шаг">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Name">@data.Name</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="StepTimingRecord" Property="Description" Title="Описание">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text" title="@data.Description">@data.Description</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="StepTimingRecord" Property="Duration" Title="Время" Width="120px">
                <Template Context="data">
                    <div class="cell-container @GetCellClass(data)">
                        <span class="cell-text">@data.Duration</span>
                    </div>
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private bool _disposed;
    private IReadOnlyList<StepTimingRecord> _timings = [];

    private static string GetCellClass(StepTimingRecord data) =>
        data.IsRunning ? "running" : "";

    protected override void OnInitialized()
    {
        StepTimingService.OnChanged += OnTimingsChanged;
        _timings = StepTimingService.GetAll();
    }

    private void OnTimingsChanged()
    {
        _ = InvokeAsync(() =>
        {
            if (_disposed) return;
            _timings = StepTimingService.GetAll();
            StateHasChanged();
        });
    }

    public ValueTask DisposeAsync()
    {
        _disposed = true;
        StepTimingService.OnChanged -= OnTimingsChanged;
        return ValueTask.CompletedTask;
    }
}
