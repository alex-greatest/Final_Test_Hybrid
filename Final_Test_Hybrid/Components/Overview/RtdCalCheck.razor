@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<style>
    /* Scoped styles for Radzen components */
    #@containerId .rz-grid-table td,
    #@containerId .rz-grid-table td .rz-cell-data,
    #@containerId .rz-grid-table td span {
        font-size: 1.1rem !important;
        font-weight: bold !important;
        color: black !important;
    }

    #@containerId .rz-grid-table input,
    #@containerId .rz-grid-table .rz-inputtext {
        font-size: 1.1rem !important;
        font-weight: bold !important;
        font-family: inherit !important;
        color: black !important;
        background-color: white !important;
        padding: 2px 4px !important;
        height: auto !important;
    }
</style>

<div id="@containerId">
    <RadzenDataGrid @ref="grid" Data="@items" TItem="RtdCalCheckItem"
                    EditMode="DataGridEditMode.Single"
                    CellClick="@OnCellClick"
                    RowUpdate="@OnUpdateRow"
                    ColumnWidth="120px">
        <Columns>
            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="PlcTag" Title="Тэг ПЛК" Width="150px">
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.PlcTag)))
                    {
                        <RadzenTextBox Style="width:100%" @bind-Value="item.PlcTag" />
                    }
                    else
                    {
                        @item.PlcTag
                    }
                </EditTemplate>
            </RadzenDataGridColumn>
            
            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="Type" Title="Тип" Width="180px">
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.Type)))
                    {
                        <RadzenTextBox Style="width:100%" @bind-Value="item.Type" />
                    }
                    else
                    {
                        @item.Type
                    }
                </EditTemplate>
            </RadzenDataGridColumn>

            @* Numeric Columns *@
            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="Raw" Title="Сырое">
                <Template Context="item">
                    @item.Raw.ToString("F3")
                </Template>
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.Raw)))
                    {
                        <RadzenNumeric TValue="double" Style="width:100%" @bind-Value="item.Raw" />
                    }
                    else
                    {
                        @item.Raw.ToString("F3")
                    }
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="Multiplier" Title="Множитель">
                <Template Context="item">
                    @item.Multiplier.ToString("F3")
                </Template>
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.Multiplier)))
                    {
                        <RadzenNumeric TValue="double" Style="width:100%" @bind-Value="item.Multiplier" />
                    }
                    else
                    {
                        @item.Multiplier.ToString("F3")
                    }
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="Offset" Title="Смещение">
                <Template Context="item">
                    @item.Offset.ToString("F3")
                </Template>
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.Offset)))
                    {
                        <RadzenNumeric TValue="double" Style="width:100%" @bind-Value="item.Offset" />
                    }
                    else
                    {
                        @item.Offset.ToString("F3")
                    }
                </EditTemplate>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="RtdCalCheckItem" Property="Calculated" Title="Вычисленное">
                <Template Context="item">
                    @item.Calculated.ToString("F3")
                </Template>
                <EditTemplate Context="item">
                    @if (IsEditing(nameof(item.Calculated)))
                    {
                        <RadzenNumeric TValue="double" Style="width:100%" @bind-Value="item.Calculated" />
                    }
                    else
                    {
                        @item.Calculated.ToString("F3")
                    }
                </EditTemplate>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
</div>

@code {
    RadzenDataGrid<RtdCalCheckItem> grid = null!;
    List<RtdCalCheckItem> items = new();
    
    RtdCalCheckItem? itemToUpdate;
    string? editingColumn;

    private string containerId = $"rtd-cal-check-{Guid.NewGuid()}";
    private DotNetObjectReference<RtdCalCheck>? dotNetHelper;
    private bool outsideClickHandlerRegistered;

    protected override void OnInitialized()
    {
        items = new List<RtdCalCheckItem>
        {
            new() { PlcTag = "TAG", Type = "Pt100", Raw = 21.700, Multiplier = 1.000, Offset = 0.000, Calculated = 21.700 },
            new() { PlcTag = "CH_TMR", Type = "Pt100", Raw = 21.700, Multiplier = 1.000, Offset = 0.000, Calculated = 21.700 },
            new() { PlcTag = "CH_TRR", Type = "Pt100", Raw = 21.700, Multiplier = 1.000, Offset = 0.000, Calculated = 21.700 },
            new() { PlcTag = "DHW_TES", Type = "Pt100", Raw = 21.700, Multiplier = 1.000, Offset = 0.000, Calculated = 21.700 },
            new() { PlcTag = "DHW_TUS", Type = "Pt100", Raw = 21.700, Multiplier = 1.000, Offset = 0.000, Calculated = 21.700 },
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RegisterOutsideClickHandler();
        }
    }

    // Helper to check if a specific column in the current row is being edited
    private bool IsEditing(string propertyName)
    {
        return editingColumn == propertyName;
    }

    async Task OnCellClick(DataGridCellMouseEventArgs<RtdCalCheckItem> args)
    {
        await SwitchEditMode(args.Data, args.Column.Property);
    }

    private async Task SwitchEditMode(RtdCalCheckItem item, string property)
    {
        if (itemToUpdate == item && editingColumn == property) return;

        // Commit previous change if any
        if (itemToUpdate != null)
        {
            await grid.UpdateRow(itemToUpdate);
        }

        itemToUpdate = item;
        editingColumn = property;

        await grid.EditRow(item);
    }

    [JSInvokable]
    public async Task CloseEdit()
    {
        if (itemToUpdate != null)
        {
            await grid.UpdateRow(itemToUpdate);
            itemToUpdate = null;
            editingColumn = null;
            await InvokeAsync(StateHasChanged);
        }
    }

    void OnUpdateRow(RtdCalCheckItem item)
    {
        // Update logic
    }

    private async Task RegisterOutsideClickHandler()
    {
        dotNetHelper = DotNetObjectReference.Create(this);
        try
        {
            await JSRuntime.InvokeVoidAsync("outsideClickHandler.add", containerId, dotNetHelper);
            outsideClickHandlerRegistered = true;
        }
        catch (JSException ex)
        {
            outsideClickHandlerRegistered = false;
            dotNetHelper?.Dispose();
            dotNetHelper = null;
            System.Diagnostics.Debug.WriteLine($"RtdCalCheck outsideClick handler registration failed: {ex.Message}");
        }
    }

    private async Task UnregisterOutsideClickHandler()
    {
        if (!outsideClickHandlerRegistered || dotNetHelper is null) return;

        try
        {
            await JSRuntime.InvokeVoidAsync("outsideClickHandler.remove", containerId);
        }
        catch
        {
            /* Ignored */
        }
    }

    public async ValueTask DisposeAsync()
    {
        await UnregisterOutsideClickHandler();
        dotNetHelper?.Dispose();
        dotNetHelper = null;
    }

    public class RtdCalCheckItem
    {
        public string PlcTag { get; set; } = "";
        public string Type { get; set; } = "";
        public double Raw { get; set; }
        public double Multiplier { get; set; }
        public double Offset { get; set; }
        public double Calculated { get; set; }
    }
}



