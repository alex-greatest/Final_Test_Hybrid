@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa.Subscription
@using Final_Test_Hybrid.Services.Common
@using Microsoft.Extensions.Logging
@inject OpcUaSubscription Subscription
@inject ILogger<LampIndicator> Logger
@implements IAsyncDisposable

<div class="row-item">
    <span>@Label</span>
    <img src="@_lampImage" alt="Lamp" class="lamp-img"/>
</div>

@code {
    /// <summary>
    /// Отображаемая метка. Также используется для Node ID, если Tag не указан.
    /// </summary>
    [Parameter] public string Label { get; set; } = "";

    /// <summary>
    /// Явный OPC-UA Node ID. Если не указан, строится из Label.
    /// </summary>
    [Parameter] public string? Tag { get; set; }

    private string _lampImage = "images/RedLamp.png";
    private string NodeId => Tag ?? InputsTags.BuildNodeId(Label);
    private bool _disposed;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await Subscription.SubscribeAsync(NodeId, OnValueChanged);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Не удалось подписаться на {NodeId}", NodeId);
        }
    }

    /// <summary>
    /// Обработчик изменения значения тега.
    /// </summary>
    private async Task OnValueChanged(object? value)
    {
        if (_disposed)
        {
            return;
        }

        var isOn = value is true;
        _lampImage = IndicatorHelper.GetLampImagePath(isOn);
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        await Subscription.UnsubscribeAsync(NodeId, OnValueChanged, removeTag: false, ct: CancellationToken.None);
    }
}
