@using Final_Test_Hybrid.Services.OpcUa.Subscription
@using Microsoft.Extensions.Logging
@inject OpcUaSubscription Subscription
@inject ILogger<ValueIndicator> Logger
@implements IAsyncDisposable

<div class="row-item">
    <span>@Label</span>

    <RadzenTextBox Value="@_displayValue"
                   ReadOnly="true"
                   class="scada-radzen-input" />
</div>

@code {
    /// <summary>
    /// Отображаемая метка.
    /// </summary>
    [Parameter] public string Label { get; set; } = "";

    /// <summary>
    /// Статическое значение для отображения (обратная совместимость).
    /// Игнорируется если указан Tag.
    /// </summary>
    [Parameter] public string Value { get; set; } = "";

    /// <summary>
    /// OPC-UA Node ID для подписки на значение.
    /// Приоритетнее чем Value.
    /// </summary>
    [Parameter] public string Tag { get; set; } = "";

    /// <summary>
    /// Формат отображения числа (по умолчанию 1 знак после запятой).
    /// </summary>
    [Parameter] public string Format { get; set; } = "F1";

    private string _displayValue = "---";
    private string _subscribedTag = "";
    private bool _disposed;

    protected override async Task OnParametersSetAsync()
    {
        if (Tag != _subscribedTag)
        {
            await UnsubscribeCurrentTagAsync();

            if (!string.IsNullOrEmpty(Tag))
            {
                try
                {
                    await Subscription.SubscribeAsync(Tag, OnValueChanged);
                    _subscribedTag = Tag;
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Не удалось подписаться на {Tag}", Tag);
                }
            }
            else
            {
                _displayValue = !string.IsNullOrEmpty(Value) ? Value : "---";
            }
        }
        else if (string.IsNullOrEmpty(Tag) && !string.IsNullOrEmpty(Value))
        {
            _displayValue = Value;
        }
    }

    /// <summary>
    /// Обработчик изменения значения тега.
    /// </summary>
    private async Task OnValueChanged(object? value)
    {
        if (_disposed)
        {
            return;
        }

        _displayValue = value switch
        {
            float f => f.ToString(Format),
            double d => d.ToString(Format),
            int i => i.ToString(),
            _ => value?.ToString() ?? "---"
        };
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Отписка от текущего тега.
    /// </summary>
    private async Task UnsubscribeCurrentTagAsync()
    {
        if (!string.IsNullOrEmpty(_subscribedTag))
        {
            await Subscription.UnsubscribeAsync(_subscribedTag, OnValueChanged, removeTag: false, ct: CancellationToken.None);
            _subscribedTag = "";
        }
    }

    public async ValueTask DisposeAsync()
    {
        _disposed = true;
        await UnsubscribeCurrentTagAsync();
    }
}
