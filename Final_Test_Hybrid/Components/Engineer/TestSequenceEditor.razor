@using Final_Test_Hybrid.Services
@using Microsoft.Extensions.Configuration
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ContextMenuService ContextMenuService
@inject IConfiguration Configuration
@inject IFilePickerService FilePickerService

<div class="editor-layout">
    <!-- Top Header: Parallel Modules -->
    <div class="area-top-header">
        <div class="top-header-content">
            <!-- Left Line + Arrow Head -->
            <div class="arrow-line"></div>
            <div class="arrow-head-right"></div>
            
            <span class="top-header-text">Sub Modules to run in parallel</span>
            
            <!-- Right Line removed as requested -->
            <div style="flex: 1;"></div>
        </div>
    </div>

    <!-- Left Header: Sequence Modules -->
    <div class="area-left-header">
        <div class="left-header-line"></div>
        <div class="left-header-arrow"></div>
        <div class="left-header-text">Sub Modules to run in Sequence</div>
        <div style="flex: 1;"></div>
    </div>

    <!-- Main Grid Area -->
    <div class="area-grid">
        <RadzenDataGrid @ref="grid" Data="@rows" TItem="SequenceRow" 
                        KeyProperty="Id"
                        Style="height: 100%; width: 100%; border: none;"
                        GridLines="DataGridGridLines.Both"
                        Density="Density.Compact"
                        AllowColumnResize="true"
                        AllowAlternatingRows="false"
                        RowSelect="@OnRowSelect"
                        RowRender="@OnRowRender"
                        CellContextMenu="@OnCellContextMenu">
            <Columns>
                @for (int i = 0; i < columnCount; i++)
                {
                    var index = i;
                    <RadzenDataGridColumn TItem="SequenceRow" Title="@($"Col {index + 1}")" Sortable="false" Filterable="false">
                        <HeaderTemplate>
                        </HeaderTemplate>
                        <Template Context="data">
                            <div class="cell-content">
                                <input class="cell-input" @bind="data.Columns[index]" placeholder="" />
                                <button class="folder-btn" @onclick="@(() => OpenFolder(data, index))">
                                    <RadzenIcon Icon="folder" Style="font-size: 26px; color: #FFC107;" />
                                </button>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    </div>

    <!-- Right Control Panel (Restored) -->
    <div class="area-right-panel">
        <!-- Push buttons to bottom with flex-end on container -->
        <RadzenButton Text="Open" Icon="folder_open" Class="right-panel-btn" Click="@OpenSequence" />
        <RadzenButton Text="Save" Icon="save" Class="right-panel-btn" Click="@SaveSequence" />
        <RadzenButton Text="Save As" Icon="save_as" Class="right-panel-btn" />
    </div>
</div>

@code {
    RadzenDataGrid<SequenceRow>? grid;
    List<SequenceRow> rows = new List<SequenceRow>();
    int columnCount = 4;

    // Simple model for the row moved to Models/SequenceRow.cs

    protected override void OnInitialized()
    {
        // Initialize with default empty rows (e.g. 20)
        for (int i = 0; i < 20; i++)
        {
            rows.Add(new SequenceRow(columnCount));
        }
    }
    
    void OnRowRender(RowRenderEventArgs<SequenceRow> args)
    {
        if (!string.IsNullOrEmpty(args.Data.CssClass))
        {
            args.Attributes.Add("class", args.Data.CssClass);
        }
    }

    void OnCellContextMenu(DataGridCellMouseEventArgs<SequenceRow> args)
    {
        ContextMenuService.Open(args, new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = "Insert Test Step", Value = 1 },
            new ContextMenuItem { Text = "Insert Row Before", Value = 2 },
            new ContextMenuItem { Text = "Delete Row", Value = 4 },
        }, 
        (e) =>
        {
             int val = (int)e.Value;

             InvokeAsync(async () =>
             {
                 // Close the context menu explicitly
                 ContextMenuService.Close();

                 switch (val)
                 {
                     case 1:
                         await InsertRowAfter(args.Data);
                         break;
                     case 2:
                         await InsertRowBefore(args.Data);
                         break;
                     case 4:
                         await DeleteRow(args.Data);
                         break;
                 }
                 
                 await grid!.Reload();
                 StateHasChanged();
             });
        });
    }

    async Task InsertRowAfter(SequenceRow currentRow)
    {
        if (grid != null)
        {
            var index = rows.IndexOf(currentRow);
            if (index >= 0)
            {
                var newRow = new SequenceRow(columnCount) { CssClass = "row-animate-new" };
                rows.Insert(index + 1, newRow);
                
                await grid.Reload(); // Show row immediately
                
                // Cleanup animation class
                await Task.Delay(1000); // Match new CSS animation duration (1.0s)
                newRow.CssClass = "";
                StateHasChanged();
            }
        }
    }

    async Task InsertRowBefore(SequenceRow currentRow)
    {
        if (grid != null)
        {
            var index = rows.IndexOf(currentRow);
            if (index >= 0)
            {
                var newRow = new SequenceRow(columnCount) { CssClass = "row-animate-new" };
                rows.Insert(index, newRow);
                
                await grid.Reload(); // Show row immediately
                
                // Cleanup animation class
                await Task.Delay(1000); // Match new CSS animation duration (1.0s)
                newRow.CssClass = "";
                StateHasChanged();
            }
        }
    }

    async Task DeleteRow(SequenceRow currentRow)
    {
        if (rows.Count > 0 && grid != null)
        {
            currentRow.CssClass = "row-animate-delete";
            await grid.Reload();
            await Task.Delay(800); // Match new CSS animation duration (0.8s)
            rows.Remove(currentRow);
            await grid.Reload(); // Reload grid after removal to update UI correctly
        }
    }

    void OnRowSelect(SequenceRow row)
    {
        // Handle row selection
    }

    void OpenFolder(SequenceRow row, int colIndex)
    {
        var rootPath = Configuration["Paths:PathToTestSteps"];
        
        if (string.IsNullOrEmpty(rootPath))
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Configuration Error", Detail = "PathToTestSteps is missing in appsettings.json" });
            return;
        }

        // Fallback if directory doesn't exist
        if (!System.IO.Directory.Exists(rootPath))
        {
             NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Path Error", Detail = $"Path not found: {rootPath}" });
             return;
        }

        string? relativePath = FilePickerService.PickFileRelative(rootPath);

        if (!string.IsNullOrEmpty(relativePath))
        {
            row.Columns[colIndex] = relativePath;
            StateHasChanged();
        }
    }

    void OpenSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Open", Detail = "Open Sequence clicked" });
    }

    void SaveSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Save", Detail = "Sequence saved" });
    }

    void CloseDialog()
    {
        DialogService.Close();
    }
}
