@using Final_Test_Hybrid.Services
@using Microsoft.Extensions.Configuration
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ContextMenuService ContextMenuService
@inject IConfiguration Configuration
@inject IFilePickerService FilePickerService

<style>
    /* Prevent scrolling on the dialog content */
    .test-sequence-editor-dialog .rz-dialog-content {
        padding: 0 !important;
        overflow: hidden !important;
        height: 100% !important; /* Ensure content takes full height */
    }

    .editor-layout {
        display: grid;
        /* Left Header | Content | Right Panel */
        grid-template-columns: 40px 1fr 160px;
        /* Top Header | Grid */
        grid-template-rows: 40px 1fr;
        height: 100%; 
        width: 100%;
        background-color: #d4d4d4;
        font-family: 'Segoe UI', sans-serif;
        overflow: hidden;
    }

    /* Header Areas */
    .area-top-header {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #e0e0e0;
        border: 1px solid #999;
        position: relative;
    }

    /* Styling for top text */
    .top-header-content {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 0 20px;
    }

    .top-header-text {
        font-size: 24px;
        margin: 0 15px;
        font-weight: bold;
        color: #000; /* Explicit black */
    }

    /* Arrow styles */
    .arrow-line {
        flex: 1;
        height: 3px;
        background: #000; /* Black line */
    }
    
    .arrow-head-right {
        width: 0; 
        height: 0; 
        border-top: 8px solid transparent;
        border-bottom: 8px solid transparent;
        border-left: 14px solid #000; /* Black triangle pointing right */
        margin-left: -1px;
    }

    /* Arrow styles for vertical text - using specific classes to avoid confusion */
    .left-header-line {
        width: 3px;
        background: #000;
        flex: 1;
    }

    .left-header-arrow {
        width: 0; 
        height: 0; 
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 14px solid #000; /* Points Down */
        margin-bottom: 15px;
    }

    .left-header-text {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        white-space: nowrap;
        font-weight: bold;
        color: #000;
        font-size: 24px;
    }

    .area-left-header {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
        background: #e0e0e0;
        border: 1px solid #999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px 0;
    }

    /* Grid Area */
    .area-grid {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
        overflow: auto;
        background: white;
        border: 1px solid #999;
    }

    /* Right Panel */
    .area-right-panel {
        grid-column: 3 / 4;
        grid-row: 1 / 3; /* Spans both top and grid rows */
        background: #d4d4d4;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-left: 1px solid #999;
        justify-content: center; /* Align content to center */
    }

    /* Scoped manually to editor-layout since we aren't using isolation file */
    .editor-layout .rz-datatable-td {
        padding: 2px !important;
        border-right: 1px solid #e0e0e0;
        border-bottom: 1px solid #e0e0e0;
    }

    .editor-layout .rz-grid-table {
        border-collapse: collapse;
    }

    .cell-content {
        display: flex;
        align-items: center;
        gap: 4px;
        width: 100%;
    }

    .folder-btn {
        color: #555;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border: 1px solid #ccc;
        background: #f0f0f0;
        border-radius: 3px;
    }

    .cell-input {
        flex: 1;
        border: 1px solid #ccc;
        background-color: white;
        height: 42px;
        font-size: 16px;
        padding: 0 10px;
        width: 100%;
        outline: none;
        font-weight: bold; /* Bold text */
        color: black;      /* Black text */
    }

    .cell-input:focus {
        border-color: #007bff;
    }

    /* Right Panel Buttons */
    .editor-layout .rz-button.right-panel-btn {
        width: 100%;
        justify-content: flex-start;
        text-align: left;
        background-color: #f0f0f0 !important;
        color: #000 !important;
        border: 1px solid #999 !important;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2) !important;
        margin-bottom: 8px;
        text-transform: none;
        font-weight: normal;
        /* Allow multiline text */
        white-space: normal !important;
        height: auto !important;
        min-height: 48px; /* Slightly smaller than 60px */
        font-size: 16px !important; /* Slightly smaller than 18px */
        padding: 10px 16px !important;
        line-height: 1.3 !important;
    }

    .editor-layout .rz-button.right-panel-btn .rz-button-icon-left {
        font-size: 24px !important; /* Slightly smaller than 28px */
        margin-right: 10px !important;
        color: #0069c0 !important; /* Blue icon color */
    }

    .editor-layout .rz-button.right-panel-btn:hover {
        background-color: #e0e0e0 !important;
    }

    /* Animations */
    .row-animate-new > td {
        animation: flash-green 1.0s ease-out; /* Quick animation */
    }

    .row-animate-delete > td {
        animation: fade-out-red 0.5s ease-out forwards;
        background-color: #ffcdd2 !important;
    }

    @@keyframes flash-green {
        0% { background-color: #28a745; color: white; }
        100% { background-color: transparent; color: inherit; }
    }

    @@keyframes fade-out-red {
        0% { opacity: 1; transform: translateX(0); background-color: #ef9a9a; }
        100% { opacity: 0; transform: translateX(-20px); background-color: #b71c1c; } /* Move further left */
    }
</style>

<div class="editor-layout">
    <!-- Top Header: Parallel Modules -->
    <div class="area-top-header">
        <div class="top-header-content">
            <!-- Left Line + Arrow Head -->
            <div class="arrow-line"></div>
            <div class="arrow-head-right"></div>
            
            <span class="top-header-text">Sub Modules to run in parallel</span>
            
            <!-- Right Line removed as requested -->
            <div style="flex: 1;"></div>
        </div>
    </div>

    <!-- Left Header: Sequence Modules -->
    <div class="area-left-header">
        <div class="left-header-line"></div>
        <div class="left-header-arrow"></div>
        <div class="left-header-text">Sub Modules to run in Sequence</div>
        <div style="flex: 1;"></div>
    </div>

    <!-- Main Grid Area -->
    <div class="area-grid">
        <RadzenDataGrid @ref="grid" Data="@rows" TItem="SequenceRow" 
                        KeyProperty="Id"
                        Style="height: 100%; width: 100%; border: none;"
                        GridLines="DataGridGridLines.Both"
                        Density="Density.Compact"
                        AllowColumnResize="true"
                        AllowAlternatingRows="false"
                        RowSelect="@OnRowSelect"
                        RowRender="@OnRowRender"
                        CellContextMenu="@OnCellContextMenu">
            <Columns>
                @for (int i = 0; i < columnCount; i++)
                {
                    var index = i;
                    <RadzenDataGridColumn TItem="SequenceRow" Title="@($"Col {index + 1}")" Sortable="false" Filterable="false">
                        <HeaderTemplate>
                        </HeaderTemplate>
                        <Template Context="data">
                            <div class="cell-content">
                                <input class="cell-input" @bind="data.Columns[index]" placeholder="" />
                                <button class="folder-btn" @onclick="@(() => OpenFolder(data, index))">
                                    <RadzenIcon Icon="folder" Style="font-size: 26px; color: #FFC107;" />
                                </button>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    </div>

    <!-- Right Control Panel (Restored) -->
    <div class="area-right-panel">
        <!-- Push buttons to bottom with flex-end on container -->
        <RadzenButton Text="Open" Icon="folder_open" Class="right-panel-btn" Click="@OpenSequence" />
        <RadzenButton Text="Save" Icon="save" Class="right-panel-btn" Click="@SaveSequence" />
        <RadzenButton Text="Save As" Icon="save_as" Class="right-panel-btn" />
    </div>
</div>

@code {
    RadzenDataGrid<SequenceRow>? grid;
    List<SequenceRow> rows = new List<SequenceRow>();
    int columnCount = 4;

    // Simple model for the row moved to Models/SequenceRow.cs

    protected override void OnInitialized()
    {
        // Initialize with default empty rows (e.g. 20)
        for (int i = 0; i < 20; i++)
        {
            rows.Add(new SequenceRow(columnCount));
        }
    }
    
    void OnRowRender(RowRenderEventArgs<SequenceRow> args)
    {
        if (!string.IsNullOrEmpty(args.Data.CssClass))
        {
            args.Attributes.Add("class", args.Data.CssClass);
        }
    }

    void OnCellContextMenu(DataGridCellMouseEventArgs<SequenceRow> args)
    {
        ContextMenuService.Open(args, new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = "Insert Test Step", Value = 1 },
            new ContextMenuItem { Text = "Insert Row Before", Value = 2 },
            new ContextMenuItem { Text = "Delete Row", Value = 4 },
        }, 
        (e) =>
        {
             int val = (int)e.Value;

             InvokeAsync(async () =>
             {
                 // Close the context menu explicitly
                 ContextMenuService.Close();

                 switch (val)
                 {
                     case 1:
                         await InsertRowAfter(args.Data);
                         break;
                     case 2:
                         await InsertRowBefore(args.Data);
                         break;
                     case 4:
                         await DeleteRow(args.Data);
                         break;
                 }
                 
                 await grid!.Reload();
                 StateHasChanged();
             });
        });
    }

    async Task InsertRowAfter(SequenceRow currentRow)
    {
        if (grid != null)
        {
            var index = rows.IndexOf(currentRow);
            if (index >= 0)
            {
                var newRow = new SequenceRow(columnCount) { CssClass = "row-animate-new" };
                rows.Insert(index + 1, newRow);
                
                await grid.Reload(); // Show row immediately
                
                // Cleanup animation class
                await Task.Delay(1000); // Match new CSS animation duration (1.0s)
                newRow.CssClass = "";
                StateHasChanged();
            }
        }
    }

    async Task InsertRowBefore(SequenceRow currentRow)
    {
        if (grid != null)
        {
            var index = rows.IndexOf(currentRow);
            if (index >= 0)
            {
                var newRow = new SequenceRow(columnCount) { CssClass = "row-animate-new" };
                rows.Insert(index, newRow);
                
                await grid.Reload(); // Show row immediately
                
                // Cleanup animation class
                await Task.Delay(1000); // Match new CSS animation duration (1.0s)
                newRow.CssClass = "";
                StateHasChanged();
            }
        }
    }

    async Task DeleteRow(SequenceRow currentRow)
    {
        if (rows.Count > 0 && grid != null)
        {
            currentRow.CssClass = "row-animate-delete";
            await grid.Reload();
            await Task.Delay(800); // Match new CSS animation duration (0.8s)
            rows.Remove(currentRow);
            await grid.Reload(); // Reload grid after removal to update UI correctly
        }
    }

    void OnRowSelect(SequenceRow row)
    {
        // Handle row selection
    }

    void OpenFolder(SequenceRow row, int colIndex)
    {
        var rootPath = Configuration["Paths:PathToTestSteps"];
        
        if (string.IsNullOrEmpty(rootPath))
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Configuration Error", Detail = "PathToTestSteps is missing in appsettings.json" });
            return;
        }

        // Fallback if directory doesn't exist
        if (!System.IO.Directory.Exists(rootPath))
        {
             NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Path Error", Detail = $"Path not found: {rootPath}" });
             return;
        }

        string? relativePath = FilePickerService.PickFileRelative(rootPath);

        if (!string.IsNullOrEmpty(relativePath))
        {
            row.Columns[colIndex] = relativePath;
            StateHasChanged();
        }
    }

    void OpenSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Open", Detail = "Open Sequence clicked" });
    }

    void SaveSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Save", Detail = "Sequence saved" });
    }

    void CloseDialog()
    {
        DialogService.Close();
    }
}
