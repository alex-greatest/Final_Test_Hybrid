@using Final_Test_Hybrid.Services
@implements IDisposable
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ContextMenuService ContextMenuService
@inject TestSequenceService TestSequenceService

<div class="editor-layout">
    <!-- Top Header: Parallel Modules -->
    <div class="area-top-header">
        <div class="top-header-content">
            <!-- Left Line + Arrow Head -->
            <div class="arrow-line"></div>
            <div class="arrow-head-right"></div>
            
            <span class="top-header-text">Sub Modules to run in parallel</span>
            
            <div style="flex: 1;"></div>
        </div>
    </div>

    <!-- Left Header: Sequence Modules -->
    <div class="area-left-header">
        <div class="left-header-line"></div>
        <div class="left-header-arrow"></div>
        <div class="left-header-text">Sub Modules to run in Sequence</div>
        <div style="flex: 1;"></div>
    </div>

    <!-- Main Grid Area -->
    <div class="area-grid">
        <RadzenDataGrid @ref="_grid" Data="@_rows" TItem="SequenceRow" 
                        KeyProperty="Id"
                        Style="height: 100%; width: 100%; border: none;"
                        GridLines="DataGridGridLines.Both"
                        Density="Density.Compact"
                        AllowColumnResize="true"
                        AllowAlternatingRows="false"
                        RowSelect="@OnRowSelect"
                        RowRender="@OnRowRender"
                        CellContextMenu="@OnCellContextMenu">
            <Columns>
                @for (var i = 0; i < _columnCount; i++)
                {
                    var index = i;
                    <RadzenDataGridColumn TItem="SequenceRow" Title="@($"Col {index + 1}")" Sortable="false" Filterable="false">
                        <HeaderTemplate>
                        </HeaderTemplate>
                        <Template Context="data">
                            <div class="cell-content">
                                <input class="cell-input" @bind="data.Columns[index]" placeholder="" />
                                <button class="folder-btn" @onclick="@(() => OpenFolder(data, index))">
                                    <RadzenIcon Icon="folder" Style="font-size: 26px; color: #FFC107;" />
                                </button>
                            </div>
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    </div>

    <!-- Right Control Panel -->
    <div class="area-right-panel">
        <RadzenButton Text="Open" Icon="folder_open" Class="right-panel-btn" Click="@OpenSequence" />
        <RadzenButton Text="Save" Icon="save" Class="right-panel-btn" Click="@SaveSequence" />
        <RadzenButton Text="Save As" Icon="save_as" Class="right-panel-btn" />
    </div>
</div>

@code {
    private RadzenDataGrid<SequenceRow>? _grid;
    private List<SequenceRow> _rows = new List<SequenceRow>();
    private int _columnCount = 4;
    private bool _disposed;

    protected override void OnInitialized()
    {
        _rows = TestSequenceService.InitializeRows(20, _columnCount);
    }
    
    private void OnRowRender(RowRenderEventArgs<SequenceRow> args)
    {
        if (!string.IsNullOrEmpty(args.Data.CssClass))
        {
            args.Attributes.Add("class", args.Data.CssClass);
        }
    }

    private void OnCellContextMenu(DataGridCellMouseEventArgs<SequenceRow> args)
    {
        var menuItems = new List<ContextMenuItem>
        {
            new ContextMenuItem { Text = "Insert Test Step", Value = 1 },
            new ContextMenuItem { Text = "Insert Row Before", Value = 2 },
            new ContextMenuItem { Text = "Delete Row", Value = 4 },
        };

        ContextMenuService.Open(args, menuItems, (e) => OnMenuItemClick(e, args.Data));
    }

    private void OnMenuItemClick(MenuItemEventArgs e, SequenceRow row)
    {
        ContextMenuService.Close();
        var actionValue = (int)e.Value;
        
        InvokeAsync(async () => await ExecuteContextAction(actionValue, row));
    }

    private async Task ExecuteContextAction(int actionValue, SequenceRow row)
    {
        if (_disposed)
        {
            return;
        }

        switch (actionValue)
        {
            case 1:
                await InsertRowAfter(row);
                break;
            case 2:
                await InsertRowBefore(row);
                break;
            case 4:
                await DeleteRow(row);
                break;
        }

        await RefreshGrid();
    }

    private async Task RefreshGrid()
    {
        if (_disposed)
        {
            return;
        }

        if (_grid != null)
        {
            await _grid.Reload();
        }
        StateHasChanged();
    }

    private async Task InsertRowAfter(SequenceRow currentRow)
    {
        var newRow = TestSequenceService.InsertRowAfter(_rows, currentRow, _columnCount);
        if (newRow != null)
        {
            await RefreshGrid();
            await Task.Delay(1000);
            
            if (_disposed)
            {
                return;
            }
            
            newRow.CssClass = "";
            StateHasChanged();
        }
    }

    private async Task InsertRowBefore(SequenceRow currentRow)
    {
        var newRow = TestSequenceService.InsertRowBefore(_rows, currentRow, _columnCount);
        if (newRow != null)
        {
             await RefreshGrid();
             await Task.Delay(1000);
             
             if (_disposed)
             {
                 return;
             }
             
             newRow.CssClass = "";
             StateHasChanged();
        }
    }

    private async Task DeleteRow(SequenceRow currentRow)
    {
        if (_rows.Count == 0)
        {
            return;
        }

        TestSequenceService.PrepareForDelete(currentRow);
        await RefreshGrid();
        
        await Task.Delay(800);
        
        if (_disposed)
        {
            return;
        }
        
        TestSequenceService.RemoveRow(_rows, currentRow);
        await RefreshGrid(); 
    }

    private void OnRowSelect(SequenceRow row)
    {
        // Handle row selection
    }

    private void OpenFolder(SequenceRow row, int colIndex)
    {
        TestSequenceService.OpenFolder(row, colIndex);
        StateHasChanged();
    }

    private void OpenSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Open", Detail = "Open Sequence clicked" });
    }

    private void SaveSequence()
    {
         NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Save", Detail = "Sequence saved" });
    }

    private void CloseDialog()
    {
        DialogService.Close();
    }

    public void Dispose()
    {
        _disposed = true;
    }
}
