@using Final_Test_Hybrid.Services.Common.UI
@using Final_Test_Hybrid.Services.Editor
@using Microsoft.Extensions.Logging
@inject INotificationService NotificationService
@inject ContextMenuService ContextMenuService
@inject TestSequenceService TestSequenceService
@inject ILogger<TestSequenceEditor> Logger

<div class="editor-layout">
    @if (_isLoading)
    {
        <div class="spinner-overlay">
            <RadzenProgressBarCircular Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
        </div>
    }

    <!-- Top Header: Parallel Modules -->
    <div class="area-top-header">
        <div class="top-header-content">
            <!-- Left Line + Arrow Head -->
            <div class="arrow-line"></div>
            <div class="arrow-head-right"></div>
            
            <span class="top-header-text">Sub Modules to run in parallel</span>
        </div>
    </div>

    <!-- Left Header: Sequence Modules -->
    <div class="area-left-header">
        <div class="left-header-line"></div>
        <div class="left-header-arrow"></div>
        <div class="left-header-text">Sub Modules to run in Sequence</div>
        <div style="flex: 1;"></div>
    </div>

    <!-- Main Grid Area -->
    <div class="area-grid">
        <RadzenDataGrid @ref="_grid" Data="@_rows" TItem="SequenceRow"
                        KeyProperty="Id"
                        Style="height: 100%; width: 100%; border: none;"
                        GridLines="DataGridGridLines.Both"
                        Density="Density.Compact"
                        AllowColumnResize="true"
                        AllowAlternatingRows="false"
                        RowRender="@OnRowRender"
                        CellContextMenu="@OnCellContextMenu"
                        EmptyText="@DataGridRu.Empty">
            <Columns>
                @for (var i = 0; i < _columnCount; i++)
                {
                    var index = i;
                    <RadzenDataGridColumn TItem="SequenceRow" Title="@($"Col {index + 1}")" Sortable="false" Filterable="false">
                        <HeaderTemplate>
                        </HeaderTemplate>
                        <Template Context="data">
                            <RadzenDropDown TValue="string"
                                            Data="@_steps"
                                            TextProperty="Name"
                                            ValueProperty="Name"
                                            @bind-Value="data.Columns[index]"
                                            Change="@(args => OnStepSelected(data, index, args))"
                                            AllowFiltering="true"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            Placeholder="Выберите шаг..."
                                            AllowClear="true"
                                            Style="width: 100%"
                                            Disabled="@(!_isFileActive)">
                                <Template Context="step">
                                    <span title="@step.Name">
                                        @step.Name
                                    </span>
                                </Template>
                                <ValueTemplate Context="step">
                                    @if (step != null)
                                    {
                                        <span title="@step.Name">
                                            @step.Name
                                        </span>
                                    }
                                </ValueTemplate>
                            </RadzenDropDown>
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    </div>

    <!-- Right Control Panel -->
    <div class="area-right-panel">
        <RadzenButton Text="Создать" Icon="note_add" Class="right-panel-btn" Click="@NewSequence" Disabled="@_isLoading" />
        <RadzenButton Text="Открыть" Icon="folder_open" Class="right-panel-btn" Click="@OpenSequence" Disabled="@_isLoading" />
        <RadzenButton Text="Сохранить" Icon="save" Class="right-panel-btn" Click="@SaveSequence" Disabled="@(_isLoading || !_isFileActive)" />
        <RadzenButton Text="Сохранить как" Icon="save_as" Class="right-panel-btn" Click="@SaveSequenceAs" Disabled="@(_isLoading || !_isFileActive)" />
    </div>
</div>
