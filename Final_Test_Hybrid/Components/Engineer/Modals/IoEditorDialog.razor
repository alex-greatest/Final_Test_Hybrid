@using Final_Test_Hybrid.Components.Overview
@using Final_Test_Hybrid.Models.Plc.Tags
@using Final_Test_Hybrid.Services.OpcUa
@using Final_Test_Hybrid.Services.OpcUa.Connection
@inherits Final_Test_Hybrid.Components.Base.GridInplaceEditorBase<IoEditorDialog.AiCalibrationItem>
@inject PlcSubscriptionState SubscriptionState
@inject OpcUaConnectionState ConnectionState
@inject OpcUaTagService TagService

<div class="io-editor-container">
    <div class="tabs-shell">
        <RadzenTabs RenderMode="TabRenderMode.Client" class="io-editor-tabs">
            <Tabs>
                <RadzenTabsItem Text="AI Calibration">
                    <div class="tab-toolbar">
                        <div class="toolbar-buttons">
                            <RadzenButton Text="Сохранить" Icon="save"
                                          Click="@SaveAsync" Disabled="@(!HasUnsavedChanges)"
                                          ButtonStyle="ButtonStyle.Primary" />
                            <RadzenButton Text="Сброс" Icon="undo"
                                          Click="@ResetChanges" Disabled="@(!HasUnsavedChanges)"
                                          ButtonStyle="ButtonStyle.Light" />
                        </div>
                    </div>

                    @if (_isLoading)
                    {
                        <div class="loading-container">
                            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                            <span>Загрузка данных...</span>
                        </div>
                    }
                    else
                    {
                        <div id="@ContainerId">
                            <RadzenDataGrid @ref="Grid" Data="@_aiItems" TItem="AiCalibrationItem"
                                            EditMode="DataGridEditMode.Single"
                                            CellClick="@OnCellClick"
                                            RowUpdate="@OnUpdateRow"
                                            ColumnWidth="120px">
                                <Columns>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="SensorName" Title="Датчик" Width="130px">
                                        <Template Context="item">
                                            @item.SensorName
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="Description" Title="Описание" Width="220px">
                                        <Template Context="item">
                                            @item.Description
                                        </Template>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="Min" Title="Мин" Width="110px">
                                        <Template Context="item">
                                            <span class="@(IsMinChanged(item) ? "cell-modified" : "")">
                                                @item.Min.ToString("F2")
                                            </span>
                                        </Template>
                                        <EditTemplate Context="item">
                                            @if (IsEditing(nameof(item.Min)))
                                            {
                                                <RadzenNumeric TValue="double" @bind-Value="item.Min" class="w-full" />
                                            }
                                            else
                                            {
                                                <span class="@(IsMinChanged(item) ? "cell-modified" : "")">
                                                    @item.Min.ToString("F2")
                                                </span>
                                            }
                                        </EditTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="Max" Title="Макс" Width="110px">
                                        <Template Context="item">
                                            <span class="@(IsMaxChanged(item) ? "cell-modified" : "")">
                                                @item.Max.ToString("F2")
                                            </span>
                                        </Template>
                                        <EditTemplate Context="item">
                                            @if (IsEditing(nameof(item.Max)))
                                            {
                                                <RadzenNumeric TValue="double" @bind-Value="item.Max" class="w-full" />
                                            }
                                            else
                                            {
                                                <span class="@(IsMaxChanged(item) ? "cell-modified" : "")">
                                                    @item.Max.ToString("F2")
                                                </span>
                                            }
                                        </EditTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="Multiplier" Title="Множитель" Width="110px">
                                        <Template Context="item">
                                            <span class="@(IsMultiplierChanged(item) ? "cell-modified" : "")">
                                                @item.Multiplier.ToString("F2")
                                            </span>
                                        </Template>
                                        <EditTemplate Context="item">
                                            @if (IsEditing(nameof(item.Multiplier)))
                                            {
                                                <RadzenNumeric TValue="double" @bind-Value="item.Multiplier" class="w-full" />
                                            }
                                            else
                                            {
                                                <span class="@(IsMultiplierChanged(item) ? "cell-modified" : "")">
                                                    @item.Multiplier.ToString("F2")
                                                </span>
                                            }
                                        </EditTemplate>
                                    </RadzenDataGridColumn>
                                    <RadzenDataGridColumn TItem="AiCalibrationItem" Property="Offset" Title="Смещение" Width="110px">
                                        <Template Context="item">
                                            <span class="@(IsOffsetChanged(item) ? "cell-modified" : "")">
                                                @item.Offset.ToString("F2")
                                            </span>
                                        </Template>
                                        <EditTemplate Context="item">
                                            @if (IsEditing(nameof(item.Offset)))
                                            {
                                                <RadzenNumeric TValue="double" @bind-Value="item.Offset" class="w-full" />
                                            }
                                            else
                                            {
                                                <span class="@(IsOffsetChanged(item) ? "cell-modified" : "")">
                                                    @item.Offset.ToString("F2")
                                                </span>
                                            }
                                        </EditTemplate>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </div>
                    }
                </RadzenTabsItem>

                <RadzenTabsItem Text="RTD Calibration">
                    <RtdCalCheck IsReadOnly="true" />
                </RadzenTabsItem>

                <RadzenTabsItem Text="PID Regulator">
                    <PidRegulatorCheck IsReadOnly="true" />
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </div>
</div>

@code {
    private List<AiCalibrationItem> _aiItems = [];
    private List<AiCalibrationItem> _aiSnapshot = [];
    private bool _isLoading = true;
    private bool _disposed;

    /// <summary>
    /// Инициализирует компонент: подписывается на события и загружает данные.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        IsReadOnly = false;

        SubscriptionState.OnStateChanged += HandleStateChanged;
        ConnectionState.ConnectionStateChanged += HandleConnectionChanged;

        await LoadAiDataAsync();
        CreateSnapshot();
        _isLoading = false;
    }

    /// <summary>
    /// Загружает данные AI Calibration из OPC.
    /// </summary>
    private async Task LoadAiDataAsync()
    {
        _aiItems = [];

        foreach (var sensor in AiCallCheckTags.Sensors)
        {
            var min = await TagService.ReadAsync<float>(
                AiCallCheckTags.BuildNodeId(sensor.Name, AiCallCheckTags.Fields.LimMin));
            var max = await TagService.ReadAsync<float>(
                AiCallCheckTags.BuildNodeId(sensor.Name, AiCallCheckTags.Fields.LimMax));
            var mult = await TagService.ReadAsync<float>(
                AiCallCheckTags.BuildNodeId(sensor.Name, AiCallCheckTags.Fields.Gain));
            var offset = await TagService.ReadAsync<float>(
                AiCallCheckTags.BuildNodeId(sensor.Name, AiCallCheckTags.Fields.Offset));

            _aiItems.Add(new AiCalibrationItem
            {
                SensorName = sensor.Name,
                Description = sensor.Description,
                Min = min.Value,
                Max = max.Value,
                Multiplier = mult.Value,
                Offset = offset.Value
            });
        }
    }

    /// <summary>
    /// Создаёт снимок текущих значений для отслеживания изменений.
    /// </summary>
    private void CreateSnapshot()
    {
        _aiSnapshot = _aiItems.Select(item => new AiCalibrationItem
        {
            SensorName = item.SensorName,
            Description = item.Description,
            Min = item.Min,
            Max = item.Max,
            Multiplier = item.Multiplier,
            Offset = item.Offset
        }).ToList();
    }

    /// <summary>
    /// Проверяет, изменилось ли значение Min для элемента.
    /// </summary>
    private bool IsMinChanged(AiCalibrationItem item)
    {
        var index = _aiItems.IndexOf(item);
        if (index < 0 || index >= _aiSnapshot.Count)
        {
            return false;
        }
        return Math.Abs(item.Min - _aiSnapshot[index].Min) > 0.0001;
    }

    /// <summary>
    /// Проверяет, изменилось ли значение Max для элемента.
    /// </summary>
    private bool IsMaxChanged(AiCalibrationItem item)
    {
        var index = _aiItems.IndexOf(item);
        if (index < 0 || index >= _aiSnapshot.Count)
        {
            return false;
        }
        return Math.Abs(item.Max - _aiSnapshot[index].Max) > 0.0001;
    }

    /// <summary>
    /// Проверяет, изменилось ли значение Multiplier для элемента.
    /// </summary>
    private bool IsMultiplierChanged(AiCalibrationItem item)
    {
        var index = _aiItems.IndexOf(item);
        if (index < 0 || index >= _aiSnapshot.Count)
        {
            return false;
        }
        return Math.Abs(item.Multiplier - _aiSnapshot[index].Multiplier) > 0.0001;
    }

    /// <summary>
    /// Проверяет, изменилось ли значение Offset для элемента.
    /// </summary>
    private bool IsOffsetChanged(AiCalibrationItem item)
    {
        var index = _aiItems.IndexOf(item);
        if (index < 0 || index >= _aiSnapshot.Count)
        {
            return false;
        }
        return Math.Abs(item.Offset - _aiSnapshot[index].Offset) > 0.0001;
    }

    /// <summary>
    /// Проверяет наличие несохранённых изменений.
    /// </summary>
    private bool HasUnsavedChanges
    {
        get
        {
            if (_aiItems.Count != _aiSnapshot.Count)
            {
                return false;
            }

            for (var i = 0; i < _aiItems.Count; i++)
            {
                var item = _aiItems[i];
                var snapshot = _aiSnapshot[i];
                if (Math.Abs(item.Min - snapshot.Min) > 0.0001 ||
                    Math.Abs(item.Max - snapshot.Max) > 0.0001 ||
                    Math.Abs(item.Multiplier - snapshot.Multiplier) > 0.0001 ||
                    Math.Abs(item.Offset - snapshot.Offset) > 0.0001)
                {
                    return true;
                }
            }
            return false;
        }
    }

    /// <summary>
    /// Сохраняет изменения в OPC.
    /// </summary>
    private async Task SaveAsync()
    {
        for (var i = 0; i < _aiItems.Count; i++)
        {
            var item = _aiItems[i];
            var snapshot = _aiSnapshot[i];

            if (Math.Abs(item.Min - snapshot.Min) > 0.0001)
            {
                await TagService.WriteAsync(
                    AiCallCheckTags.BuildNodeId(item.SensorName, AiCallCheckTags.Fields.LimMin), (float)item.Min);
            }

            if (Math.Abs(item.Max - snapshot.Max) > 0.0001)
            {
                await TagService.WriteAsync(
                    AiCallCheckTags.BuildNodeId(item.SensorName, AiCallCheckTags.Fields.LimMax), (float)item.Max);
            }

            if (Math.Abs(item.Multiplier - snapshot.Multiplier) > 0.0001)
            {
                await TagService.WriteAsync(
                    AiCallCheckTags.BuildNodeId(item.SensorName, AiCallCheckTags.Fields.Gain), (float)item.Multiplier);
            }

            if (Math.Abs(item.Offset - snapshot.Offset) > 0.0001)
            {
                await TagService.WriteAsync(
                    AiCallCheckTags.BuildNodeId(item.SensorName, AiCallCheckTags.Fields.Offset), (float)item.Offset);
            }
        }

        CreateSnapshot();
        StateHasChanged();
    }

    /// <summary>
    /// Сбрасывает изменения к исходным значениям.
    /// </summary>
    private void ResetChanges()
    {
        for (var i = 0; i < _aiItems.Count; i++)
        {
            _aiItems[i].Min = _aiSnapshot[i].Min;
            _aiItems[i].Max = _aiSnapshot[i].Max;
            _aiItems[i].Multiplier = _aiSnapshot[i].Multiplier;
            _aiItems[i].Offset = _aiSnapshot[i].Offset;
        }
        StateHasChanged();
    }

    private void HandleStateChanged()
    {
        if (_disposed)
        {
            return;
        }
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleConnectionChanged(bool isConnected)
    {
        if (_disposed)
        {
            return;
        }
        _ = InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Освобождает ресурсы компонента.
    /// </summary>
    public override async ValueTask DisposeAsync()
    {
        _disposed = true;
        SubscriptionState.OnStateChanged -= HandleStateChanged;
        ConnectionState.ConnectionStateChanged -= HandleConnectionChanged;
        await base.DisposeAsync();
    }

    public class AiCalibrationItem
    {
        public string SensorName { get; set; } = "";
        public string Description { get; set; } = "";
        public double Min { get; set; }
        public double Max { get; set; }
        public double Multiplier { get; set; }
        public double Offset { get; set; }
    }
}
