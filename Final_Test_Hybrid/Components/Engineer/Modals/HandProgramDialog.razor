@using Final_Test_Hybrid.Components.Schemes
@using Final_Test_Hybrid.Components.Overview
@using Final_Test_Hybrid.Services.OpcUa
@using Final_Test_Hybrid.Services.OpcUa.Connection
@using Final_Test_Hybrid.Services.Steps.Infrastructure.Execution.PreExecution
@inject PlcSubscriptionState SubscriptionState
@inject OpcUaConnectionState ConnectionState
@inject PreExecutionCoordinator PreExecution
@inject DialogService DialogService
@implements IAsyncDisposable

<div class="hand-program-container">
    <div class="tabs-shell">
        <RadzenTabs RenderMode="TabRenderMode.Client"
                    @bind-SelectedIndex="_selectedTabIndex"
                    class="hand-program-tabs">
            <Tabs>
                <RadzenTabsItem Text="Газ">
                    <GasScheme EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Отопление">
                    <HeatingScheme EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Горячая вода">
                    <HotWaterScheme EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Входы 1">
                    <InputsPanel1 EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="RTD входы">
                    <RtdInputsPanel EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Входы 2">
                    <InputsPanel2 EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Выходы 1">
                    <OutputsPanel1 IsInteractive="true" EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Пн. выходы">
                    <PneumaticOutputsPanel IsInteractive="true" EmitCachedValueImmediately="true" />
                </RadzenTabsItem>
                <RadzenTabsItem Text="Тест связи">
                    @if (_selectedTabIndex == TestConnectionTabIndex)
                    {
                        <ConnectionTestPanel />
                    }
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </div>
</div>

@code {
    private const int TestConnectionTabIndex = 8;

    private bool _disposed;
    private bool _isClosing;
    private int _selectedTabIndex;

    protected override void OnInitialized()
    {
        SubscriptionState.OnStateChanged += HandleStateChanged;
        ConnectionState.ConnectionStateChanged += HandleConnectionChanged;
        PreExecution.OnStateChanged += HandlePreExecutionChanged;
    }

    private void HandleStateChanged()
    {
        if (_disposed)
        {
            return;
        }
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandleConnectionChanged(bool isConnected)
    {
        if (_disposed)
        {
            return;
        }
        _ = InvokeAsync(StateHasChanged);
    }

    private void HandlePreExecutionChanged()
    {
        if (_disposed || _isClosing || PreExecution.IsAcceptingInput)
        {
            return;
        }

        _isClosing = true;
        _ = InvokeAsync(() => DialogService.Close());
    }

    public ValueTask DisposeAsync()
    {
        _disposed = true;
        SubscriptionState.OnStateChanged -= HandleStateChanged;
        ConnectionState.ConnectionStateChanged -= HandleConnectionChanged;
        PreExecution.OnStateChanged -= HandlePreExecutionChanged;
        return ValueTask.CompletedTask;
    }
}
